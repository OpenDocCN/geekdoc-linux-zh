<html><head></head><body>
    <div style="page-break-after: always;"/>
    <h1>The <code>!!</code> command (History Expansion)</h1>
    <p>The <code>!!</code> command is a bash history expansion feature that repeats the last command. It's part of a broader set of history expansion capabilities that allow you to quickly re-execute, modify, or reference previous commands. This is extremely useful for correcting mistakes, adding sudo, or repeating complex commands.</p>
    <h2>Syntax</h2>
    <pre>
      <code class="language-xml hljs xml" data-lang="xml">!!
!<span class="hljs-tag">&lt;<span class="hljs-name">event</span>&gt;</span>
!<span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>
!?<span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>?
</code>
    </pre>
    <h2>Key Features</h2>
    <ul>
      <li><strong>Last Command Repetition</strong>: Quickly re-run the previous command</li>
      <li><strong>Command Modification</strong>: Modify and re-execute previous commands</li>
      <li><strong>Argument Extraction</strong>: Extract specific arguments from previous commands</li>
      <li><strong>Pattern Matching</strong>: Find commands by pattern</li>
      <li><strong>Time Saving</strong>: Avoid retyping complex commands</li>
    </ul>
    <h2>Basic Usage</h2>
    <h3>Simple History Expansion</h3>
    <pre>
      <code class="language-bash hljs bash" data-lang="bash"><span class="hljs-comment"># Run a command</span>
ls -la /home/user

<span class="hljs-comment"># Repeat the last command</span>
!!

<span class="hljs-comment"># Add sudo to the last command</span>
sudo !!

<span class="hljs-comment"># This is equivalent to:</span>
sudo ls -la /home/user
</code>
    </pre>
    <h3>Common Scenarios</h3>
    <pre>
      <code class="language-bash hljs bash" data-lang="bash"><span class="hljs-comment"># Forgot sudo</span>
apt update
<span class="hljs-comment"># Permission denied</span>

<span class="hljs-comment"># Fix with sudo</span>
sudo !!
<span class="hljs-comment"># Executes: sudo apt update</span>

<span class="hljs-comment"># Wrong directory</span>
<span class="hljs-built_in">cd</span> /var/logs
<span class="hljs-comment"># No such file or directory</span>

<span class="hljs-comment"># Fix the path</span>
<span class="hljs-built_in">cd</span> /var/<span class="hljs-built_in">log</span>
<span class="hljs-comment"># Then repeat with correct path</span>
!!
</code>
    </pre>
    <h2>History Expansion Patterns</h2>
    <h3>1. Event Designators</h3>
    <pre>
      <code class="language-bash hljs bash" data-lang="bash"><span class="hljs-comment"># !! - Last command</span>
!!

<span class="hljs-comment"># !n - Command number n</span>
!123

<span class="hljs-comment"># !-n - nth command back</span>
!-2    <span class="hljs-comment"># Two commands ago</span>
!-5    <span class="hljs-comment"># Five commands ago</span>

<span class="hljs-comment"># !string - Most recent command starting with 'string'</span>
!ls    <span class="hljs-comment"># Last command starting with 'ls'</span>
!git   <span class="hljs-comment"># Last command starting with 'git'</span>

<span class="hljs-comment"># !?string? - Most recent command containing 'string'</span>
!?config?   <span class="hljs-comment"># Last command containing 'config'</span>
!?file?     <span class="hljs-comment"># Last command containing 'file'</span>
</code>
    </pre>
    <h3>2. Word Designators</h3>
    <pre>
      <code class="language-bash hljs bash" data-lang="bash"><span class="hljs-comment"># Previous command: git commit -m "Fix bug" --amend</span><span class="hljs-comment"># !^ - First argument</span><span class="hljs-built_in">echo</span> !^        <span class="hljs-comment"># echo commit</span>

<span class="hljs-comment"># !$ - Last argument</span>
<span class="hljs-built_in">echo</span> !$        <span class="hljs-comment"># echo --amend</span>

<span class="hljs-comment"># !* - All arguments</span>
<span class="hljs-built_in">echo</span> !*        <span class="hljs-comment"># echo commit -m "Fix bug" --amend</span>

<span class="hljs-comment"># !:n - nth argument (0-based)</span>
<span class="hljs-built_in">echo</span> !:0       <span class="hljs-comment"># echo git</span>
<span class="hljs-built_in">echo</span> !:1       <span class="hljs-comment"># echo commit</span>
<span class="hljs-built_in">echo</span> !:2       <span class="hljs-comment"># echo -m</span>

<span class="hljs-comment"># !:n-m - Range of arguments</span>
<span class="hljs-built_in">echo</span> !:1-3     <span class="hljs-comment"># echo commit -m "Fix bug"</span>
</code>
    </pre>
    <h3>3. Modifiers</h3>
    <pre>
      <code class="language-bash hljs bash" data-lang="bash"><span class="hljs-comment"># Previous command: ls /home/user/documents/file.txt</span><span class="hljs-comment"># :h - Remove trailing pathname component (head)</span><span class="hljs-built_in">echo</span> !!:h      <span class="hljs-comment"># echo /home/user/documents</span>

<span class="hljs-comment"># :t - Remove leading pathname components (tail)</span>
<span class="hljs-built_in">echo</span> !!:t      <span class="hljs-comment"># echo file.txt</span>

<span class="hljs-comment"># :r - Remove trailing suffix</span>
<span class="hljs-built_in">echo</span> !!:r      <span class="hljs-comment"># echo /home/user/documents/file</span>

<span class="hljs-comment"># :e - Remove all but trailing suffix</span>
<span class="hljs-built_in">echo</span> !!:e      <span class="hljs-comment"># echo txt</span>

<span class="hljs-comment"># :s/old/new/ - Substitute first occurrence</span>
!!:s/user/admin/   <span class="hljs-comment"># ls /home/admin/documents/file.txt</span>

<span class="hljs-comment"># :gs/old/new/ - Global substitution</span>
!!:gs/o/0/         <span class="hljs-comment"># ls /h0me/user/d0cuments/file.txt</span>
</code>
    </pre>
    <h2>Practical Examples</h2>
    <h3>1. Error Correction</h3>
    <pre>
      <code class="language-bash hljs bash" data-lang="bash"><span class="hljs-comment"># Typo in command</span>
ct /etc/hosts
<span class="hljs-comment"># Command not found</span>

<span class="hljs-comment"># Correct and re-run</span>
cat /etc/hosts

<span class="hljs-comment"># Then if you need to edit it</span>
sudo vi !!    <span class="hljs-comment"># Becomes: sudo vi /etc/hosts</span>
</code>
    </pre>
    <h3>2. Adding Missing Options</h3>
    <pre>
      <code class="language-bash hljs bash" data-lang="bash"><span class="hljs-comment"># Run command without verbose</span>
tar -czf backup.tar.gz /home/user

<span class="hljs-comment"># Add verbose flag</span>
!!:s/-czf/-czvf/
<span class="hljs-comment"># Becomes: tar -czvf backup.tar.gz /home/user</span>

<span class="hljs-comment"># Or simpler approach</span>
tar -czvf backup.tar.gz /home/user
</code>
    </pre>
    <h3>3. File Operations</h3>
    <pre>
      <code class="language-bash hljs bash" data-lang="bash"><span class="hljs-comment"># Create file</span>
touch /tmp/test_file.txt

<span class="hljs-comment"># Edit the same file</span>
vi !!:$     <span class="hljs-comment"># vi /tmp/test_file.txt</span>

<span class="hljs-comment"># Copy to different location</span>
cp !!:$ /home/user/
<span class="hljs-comment"># Becomes: cp /tmp/test_file.txt /home/user/</span>

<span class="hljs-comment"># Previous command: find /var/log -name "*.log" -size +10M</span>
<span class="hljs-comment"># Copy found files</span>
cp !!:3 !!:4 !!:5 /backup/
<span class="hljs-comment"># Using specific arguments from find command</span>
</code>
    </pre>
    <h3>4. Directory Navigation</h3>
    <pre>
      <code class="language-bash hljs bash" data-lang="bash"><span class="hljs-comment"># Change to a directory</span><span class="hljs-built_in">cd</span> /usr/<span class="hljs-built_in">local</span>/bin

<span class="hljs-comment"># List contents</span>
ls !!:$     <span class="hljs-comment"># ls /usr/local/bin</span>

<span class="hljs-comment"># Go back and then to related directory</span>
<span class="hljs-built_in">cd</span> /usr/<span class="hljs-built_in">local</span>/src
<span class="hljs-comment"># ... later ...</span>
<span class="hljs-built_in">cd</span> !!:h/bin    <span class="hljs-comment"># cd /usr/local/bin</span>
</code>
    </pre>
    <h2>Advanced History Expansion</h2>
    <h3>1. Complex Substitutions</h3>
    <pre>
      <code class="language-bash hljs bash" data-lang="bash"><span class="hljs-comment"># Previous: rsync -av /home/user/docs/ backup@server:/backup/user/docs/</span><span class="hljs-comment"># Change source directory</span>
!!:s/docs/pictures/
<span class="hljs-comment"># Becomes: rsync -av /home/user/pictures/ backup@server:/backup/user/docs/</span>

<span class="hljs-comment"># Change both source and destination</span>
!!:s/docs/pictures/:s/user\/docs/user\/pictures/
<span class="hljs-comment"># Global changes</span>
!!:gs/docs/pictures/
</code>
    </pre>
    <h3>2. Combining with Other Features</h3>
    <pre>
      <code class="language-bash hljs bash" data-lang="bash"><span class="hljs-comment"># Previous: find /var/log -name "*.log" -type f -exec ls -l {} \;</span><span class="hljs-comment"># Modify to use different action</span>
!!:s/-<span class="hljs-built_in">exec</span> ls -l/-<span class="hljs-built_in">exec</span> wc -l/
<span class="hljs-comment"># Count lines instead of listing</span>

<span class="hljs-comment"># Extract just the find portion</span>
!:0-4    <span class="hljs-comment"># find /var/log -name "*.log" -type f</span>

<span class="hljs-comment"># Use arguments with different command</span>
grep <span class="hljs-string">"error"</span> !!:3  <span class="hljs-comment"># grep "error" "*.log"</span>
</code>
    </pre>
    <h3>3. Working with Multiple Commands</h3>
    <pre>
      <code class="language-bash hljs bash" data-lang="bash"><span class="hljs-comment"># Pipeline command</span>
ps aux | grep apache | grep -v grep

<span class="hljs-comment"># Modify the grep pattern</span>
!!:s/apache/nginx/
<span class="hljs-comment"># Becomes: ps aux | grep nginx | grep -v grep</span>

<span class="hljs-comment"># Extract just part of pipeline</span>
!:0-2     <span class="hljs-comment"># ps aux | grep apache</span>

<span class="hljs-comment"># Add to existing pipeline</span>
!! | wc -l    <span class="hljs-comment"># Count the results</span>
</code>
    </pre>
    <h2>Interactive Features</h2>
    <h3>1. History Verification</h3>
    <pre>
      <code class="language-bash hljs bash" data-lang="bash"><span class="hljs-comment"># Enable history verification (before execution)</span><span class="hljs-built_in">set</span> +H    <span class="hljs-comment"># Disable history expansion</span>
<span class="hljs-built_in">set</span> -H    <span class="hljs-comment"># Enable history expansion</span>

<span class="hljs-comment"># Show command before execution</span>
<span class="hljs-built_in">shopt</span> -s histverify
<span class="hljs-comment"># Now !! will show the command and wait for Enter</span>
</code>
    </pre>
    <h3>2. History Search</h3>
    <pre>
      <code class="language-bash hljs bash" data-lang="bash"><span class="hljs-comment"># Ctrl+R - Reverse search</span><span class="hljs-comment"># Type to search through history</span><span class="hljs-comment"># Ctrl+R again to find previous matches</span><span class="hljs-comment"># Search for specific command</span>
!?git commit?    <span class="hljs-comment"># Find last command containing "git commit"</span>
!?ssh?           <span class="hljs-comment"># Find last command containing "ssh"</span>
</code>
    </pre>
    <h2>Configuration and Settings</h2>
    <h3>1. History Settings</h3>
    <pre>
      <code class="language-bash hljs bash" data-lang="bash"><span class="hljs-comment"># History size</span><span class="hljs-built_in">export</span> HISTSIZE=1000        <span class="hljs-comment"># Commands in memory</span>
<span class="hljs-built_in">export</span> HISTFILESIZE=2000    <span class="hljs-comment"># Commands in file</span>

<span class="hljs-comment"># History control</span>
<span class="hljs-built_in">export</span> HISTCONTROL=ignoreboth    <span class="hljs-comment"># Ignore duplicates and spaces</span>
<span class="hljs-built_in">export</span> HISTCONTROL=ignoredups    <span class="hljs-comment"># Ignore duplicates only</span>

<span class="hljs-comment"># History ignore patterns</span>
<span class="hljs-built_in">export</span> HISTIGNORE=<span class="hljs-string">"ls:cd:cd -:pwd:exit:date:* --help"</span>

<span class="hljs-comment"># Timestamp in history</span>
<span class="hljs-built_in">export</span> HISTTIMEFORMAT=<span class="hljs-string">"%F %T "</span>
</code>
    </pre>
    <h3>2. History Expansion Settings</h3>
    <pre>
      <code class="language-bash hljs bash" data-lang="bash"><span class="hljs-comment"># Check if history expansion is enabled</span><span class="hljs-built_in">set</span> +o | grep histexpand

<span class="hljs-comment"># Enable history expansion</span>
<span class="hljs-built_in">set</span> -H
<span class="hljs-comment"># or</span>
<span class="hljs-built_in">set</span> -o histexpand

<span class="hljs-comment"># Disable history expansion</span>
<span class="hljs-built_in">set</span> +H
<span class="hljs-comment"># or</span>
<span class="hljs-built_in">set</span> +o histexpand
</code>
    </pre>
    <h2>Safety and Best Practices</h2>
    <h3>1. Verification Before Execution</h3>
    <pre>
      <code class="language-bash hljs bash" data-lang="bash"><span class="hljs-comment"># Enable command verification</span><span class="hljs-built_in">shopt</span> -s histverify

<span class="hljs-comment"># This makes !! show the command first, requiring Enter to execute</span>

<span class="hljs-comment"># Check what command will be executed</span>
<span class="hljs-built_in">history</span> | tail -1    <span class="hljs-comment"># See last command</span>
<span class="hljs-built_in">echo</span> !!             <span class="hljs-comment"># See what !! would execute (without running it)</span>
</code>
    </pre>
    <h3>2. Safe Practices</h3>
    <pre>
      <code class="language-bash hljs bash" data-lang="bash"><span class="hljs-comment"># Be careful with destructive commands</span>
rm -rf /tmp/*
<span class="hljs-comment"># Don't blindly run !! after such commands</span>

<span class="hljs-comment"># Use history to verify</span>
<span class="hljs-built_in">history</span> | tail -5    <span class="hljs-comment"># Check recent commands</span>

<span class="hljs-comment"># For critical operations, type commands fully</span>
<span class="hljs-comment"># Don't rely on history expansion for:</span>
<span class="hljs-comment"># - rm commands</span>
<span class="hljs-comment"># - chmod commands</span>
<span class="hljs-comment"># - System configuration changes</span>
</code>
    </pre>
    <h3>3. Debugging</h3>
    <pre>
      <code class="language-bash hljs bash" data-lang="bash"><span class="hljs-comment"># See history expansion in action</span><span class="hljs-built_in">set</span> -x    <span class="hljs-comment"># Enable command tracing</span>
!!        <span class="hljs-comment"># You'll see the expanded command</span>
<span class="hljs-built_in">set</span> +x    <span class="hljs-comment"># Disable tracing</span>

<span class="hljs-comment"># Check history before using</span>
<span class="hljs-built_in">history</span> 10    <span class="hljs-comment"># Show last 10 commands</span>
!-2           <span class="hljs-comment"># Run 2nd to last command</span>
</code>
    </pre>
    <h2>Common Patterns and Shortcuts</h2>
    <h3>1. Frequent Combinations</h3>
    <pre>
      <code class="language-bash hljs bash" data-lang="bash"><span class="hljs-comment"># Add sudo to last command</span>
sudo !!

<span class="hljs-comment"># Redirect last command output</span>
!! &gt; output.txt
!! 2&gt;&amp;1 | tee log.txt

<span class="hljs-comment"># Background last command</span>
!! &amp;

<span class="hljs-comment"># Time last command</span>
time !!

<span class="hljs-comment"># Run last command in different directory</span>
(<span class="hljs-built_in">cd</span> /tmp &amp;&amp; !!)
</code>
    </pre>
    <h3>2. File and Directory Operations</h3>
    <pre>
      <code class="language-bash hljs bash" data-lang="bash"><span class="hljs-comment"># Previous: vi /etc/apache2/sites-available/default</span><span class="hljs-comment"># Test the configuration</span>
apache2ctl -t

<span class="hljs-comment"># Copy the file</span>
cp !!:$ !!:$:r.backup    <span class="hljs-comment"># cp /etc/apache2/sites-available/default /etc/apache2/sites-available/default.backup</span>

<span class="hljs-comment"># Edit related file</span>
vi !!:h/sites-enabled/default    <span class="hljs-comment"># vi /etc/apache2/sites-enabled/default</span>
</code>
    </pre>
    <h3>3. Network and System Commands</h3>
    <pre>
      <code class="language-bash hljs bash" data-lang="bash"><span class="hljs-comment"># Check service status</span>
systemctl status apache2

<span class="hljs-comment"># Restart if needed</span>
sudo !!:s/status/restart/    <span class="hljs-comment"># sudo systemctl restart apache2</span>

<span class="hljs-comment"># Check multiple services</span>
systemctl status nginx
!!:s/nginx/mysql/           <span class="hljs-comment"># systemctl status mysql</span>
!!:s/mysql/postgresql/      <span class="hljs-comment"># systemctl status postgresql</span>
</code>
    </pre>
    <h2>Integration with Scripts</h2>
    <h3>1. History in Scripts</h3>
    <pre>
      <code class="language-bash hljs bash" data-lang="bash"><span class="hljs-meta">#!/bin/bash</span><span class="hljs-comment"># Note: History expansion doesn't work in scripts by default</span><span class="hljs-comment"># Enable it explicitly if needed</span><span class="hljs-built_in">set</span> -H    <span class="hljs-comment"># Enable history expansion in script</span>

<span class="hljs-comment"># Use variables instead of history expansion in scripts</span>
last_command=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"Re-running: <span class="hljs-variable">$last_command</span>"</span>
<span class="hljs-built_in">eval</span> <span class="hljs-string">"<span class="hljs-variable">$last_command</span>"</span>
</code>
    </pre>
    <h3>2. Interactive Scripts</h3>
    <pre>
      <code class="language-bash hljs bash" data-lang="bash"><span class="hljs-meta">#!/bin/bash</span><span class="hljs-comment"># Interactive script using history concepts</span><span class="hljs-keyword">while</span> <span class="hljs-literal">true</span>; <span class="hljs-keyword">do</span>
    <span class="hljs-built_in">read</span> -p <span class="hljs-string">"Command: "</span> cmd

    <span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">$cmd</span>"</span> = <span class="hljs-string">"!!"</span> ]; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"Re-running: <span class="hljs-variable">$last_cmd</span>"</span>
        <span class="hljs-built_in">eval</span> <span class="hljs-string">"<span class="hljs-variable">$last_cmd</span>"</span>
    <span class="hljs-keyword">elif</span> [ <span class="hljs-string">"<span class="hljs-variable">$cmd</span>"</span> = <span class="hljs-string">"exit"</span> ]; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">break</span>
    <span class="hljs-keyword">else</span>
        <span class="hljs-built_in">eval</span> <span class="hljs-string">"<span class="hljs-variable">$cmd</span>"</span>
        last_cmd=<span class="hljs-string">"<span class="hljs-variable">$cmd</span>"</span>
    <span class="hljs-keyword">fi</span>
<span class="hljs-keyword">done</span>
</code>
    </pre>
    <h2>Alternatives and Related Commands</h2>
    <h3>1. fc (Fix Command)</h3>
    <pre>
      <code class="language-bash hljs bash" data-lang="bash"><span class="hljs-comment"># Edit last command in editor</span><span class="hljs-built_in">fc</span><span class="hljs-comment"># Edit specific command number</span><span class="hljs-built_in">fc</span> 123

<span class="hljs-comment"># List recent commands</span>
<span class="hljs-built_in">fc</span> -l

<span class="hljs-comment"># Re-run range of commands</span>
<span class="hljs-built_in">fc</span> -s 100 105
</code>
    </pre>
    <h3>2. history command</h3>
    <pre>
      <code class="language-bash hljs bash" data-lang="bash"><span class="hljs-comment"># Show command history</span><span class="hljs-built_in">history</span><span class="hljs-comment"># Show last 10 commands</span><span class="hljs-built_in">history</span> 10

<span class="hljs-comment"># Execute specific command number</span>
!123

<span class="hljs-comment"># Search and execute</span>
<span class="hljs-built_in">history</span> | grep git
!456
</code>
    </pre>
    <h2>Troubleshooting</h2>
    <h3>1. History Expansion Not Working</h3>
    <pre>
      <code class="language-bash hljs bash" data-lang="bash"><span class="hljs-comment"># Check if enabled</span><span class="hljs-built_in">set</span> +o | grep histexpand

<span class="hljs-comment"># Enable it</span>
<span class="hljs-built_in">set</span> -H

<span class="hljs-comment"># Check in current shell</span>
<span class="hljs-built_in">echo</span> $-    <span class="hljs-comment"># Should contain 'H'</span>
</code>
    </pre>
    <h3>2. Unexpected Expansions</h3>
    <pre>
      <code class="language-bash hljs bash" data-lang="bash"><span class="hljs-comment"># Escape ! to prevent expansion</span><span class="hljs-built_in">echo</span> <span class="hljs-string">"The price is \$5\!"</span>

<span class="hljs-comment"># Use single quotes</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">'The price is $5!'</span>

<span class="hljs-comment"># Disable temporarily</span>
<span class="hljs-built_in">set</span> +H
<span class="hljs-built_in">echo</span> <span class="hljs-string">"Commands with ! work normally"</span>
<span class="hljs-built_in">set</span> -H
</code>
    </pre>
    <h3>3. Complex Command Issues</h3>
    <pre>
      <code class="language-bash hljs bash" data-lang="bash"><span class="hljs-comment"># For very complex commands, use variables</span>
complex_cmd=<span class="hljs-string">"find /var/log -name '*.log' -exec grep 'error' {} \;"</span>
<span class="hljs-built_in">eval</span> <span class="hljs-string">"<span class="hljs-variable">$complex_cmd</span>"</span>

<span class="hljs-comment"># Then modify variable instead of using history expansion</span>
complex_cmd=<span class="hljs-string">"<span class="hljs-variable">${complex_cmd/error/warning}</span>"</span>
<span class="hljs-built_in">eval</span> <span class="hljs-string">"<span class="hljs-variable">$complex_cmd</span>"</span>
</code>
    </pre>
    <h2>Important Notes</h2>
    <ul>
      <li><strong>Interactive Only</strong>: History expansion primarily works in interactive shells</li>
      <li><strong>Not in Scripts</strong>: Usually disabled in scripts for safety</li>
      <li><strong>Shell Specific</strong>: This is a bash/zsh feature, not available in all shells</li>
      <li><strong>Verification</strong>: Use <code>histverify</code> option for safety with destructive commands</li>
      <li><strong>Case Sensitive</strong>: History expansion is case-sensitive</li>
      <li><strong>Immediate Execution</strong>: !! executes immediately; use caution with destructive commands</li>
    </ul>
    <p>The <code>!!</code> command and history expansion features are powerful tools for efficient command-line work, but they require understanding and careful use to avoid mistakes.</p>
    <p>For more details, check the bash manual: <code>man bash</code> (search for "History Expansion")</p>
  </body></html>