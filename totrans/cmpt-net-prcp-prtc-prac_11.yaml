- en: Interdomain routing#
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 原文：[https://4ed.computer-networking.info/syllabus/default/networks/bgp.html](https://4ed.computer-networking.info/syllabus/default/networks/bgp.html)
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
- en: As explained earlier, the Internet is composed of more than 100,000 different
    networks [[1]](#fasnum) called domains. Each domain is composed of a group of
    routers and hosts that are managed by the same organization. Example domains include
    [belnet](https://www.belnet.be), [sprint](https://www.sprint.net/), [level3](https://www.lumen.com),
    [geant](https://www.geant.net), [abilene](https://www.internet2.edu), [cisco](https://www.cisco.com)
    or [google](https://www.google.com) …
  prefs: []
  type: TYPE_NORMAL
- en: 'Each domain contains a set of routers. From a routing point of view, these
    domains can be divided into two classes : the transit and the stub domains. A
    stub domain sends and receives packets whose source or destination are one of
    its own hosts. A transit domain is a domain that provides a transit service for
    other domains, i.e. the routers in this domain forward packets whose source and
    destination do not belong to the transit domain. As of this writing, about 85%
    of the domains in the Internet are stub domains [[2]](#fpotaroo). A stub domain
    that is connected to a single transit domain is called a single-homed stub (e.g.,
    S1 in figure [Fig. 151](#fig-transit-stub).). A multihomed stub is a stub domain
    connected to two or more transit providers (e.g., S2).'
  prefs: []
  type: TYPE_NORMAL
- en: '[![../_images/transit-stub.png](../Images/b9d5e18667918170f0100c7c633d6575.png)](../_images/transit-stub.png)'
  prefs: []
  type: TYPE_NORMAL
- en: Fig. 151 Transit and stub domains[#](#id29 "Link to this image")
  prefs: []
  type: TYPE_NORMAL
- en: The stub domains can be further classified by considering whether they mainly
    send or receive packets. An access-rich stub domain is a domain that contains
    hosts that mainly receive packets. Typical examples include small ADSL- or cable
    modem-based Internet Service Providers or enterprise networks. On the other hand,
    a content-rich stub domain is a domain that mainly produces packets. Examples
    of content-rich stub domains include [google](https://www.google.com), [yahoo](https://www.yahoo.com),
    [microsoft](https://www.microsoft.com), [facebook](https://www.facebook.com) or
    content distribution networks such as [akamai](https://www.akamai.com) or [limelight](https://uk.limelightnetworks.com/index.php).
    For the last few years, we have seen a rapid growth of these content-rich stub
    domains. Recent measurements [[ATLAS2009]](../bibliography.html#atlas2009) indicate
    that a growing fraction of all the packets exchanged on the Internet are produced
    in the data centers managed by these content providers.
  prefs: []
  type: TYPE_NORMAL
- en: Domains need to be interconnected to allow a host inside a domain to exchange
    IP packets with hosts located in other domains. From a physical perspective, domains
    can be interconnected in two different ways. The first solution is to directly
    connect a router belonging to the first domain with a router inside the second
    domain. Such links between domains are called private interdomain links or private
    peering links. In practice, for redundancy or performance reasons, distinct physical
    links are usually established between different routers in the two domains that
    are interconnected.
  prefs: []
  type: TYPE_NORMAL
- en: '[![../_images/private-peer.png](../Images/e2ecaec9b0430d860633a8347e635865.png)](../_images/private-peer.png)'
  prefs: []
  type: TYPE_NORMAL
- en: Fig. 152 Interconnection of two domains via a private peering link[#](#id30
    "Link to this image")
  prefs: []
  type: TYPE_NORMAL
- en: Such private peering links are useful when, for example, an enterprise or university
    network needs to be connected to its Internet Service Provider. However, some
    domains are connected to hundreds of other domains [[3]](#fasrank) . For some
    of these domains, using only private peering links would be too costly. A better
    solution to allow many domains to cheaply interconnect are the Internet eXchange
    Points ([IXP](../glossary.html#term-IXP)). An [IXP](../glossary.html#term-IXP)
    is usually some space in a data center that hosts routers belonging to different
    domains. A domain willing to exchange packets with other domains present at the
    [IXP](../glossary.html#term-IXP) installs one of its routers on the [IXP](../glossary.html#term-IXP)
    and connects it to other routers inside its own network. The IXP contains a Local
    Area Network to which all the participating routers are connected. When two domains
    that are present at the IXP wish [[4]](#fwish) to exchange packets, they simply
    use the Local Area Network. IXPs are very popular in Europe and many Internet
    Service Providers and Content providers are present in these IXPs.
  prefs: []
  type: TYPE_NORMAL
- en: '[![../_images/ixp.png](../Images/221a6b5e300e1c15e16ba90766f0a82f.png)](../_images/ixp.png)'
  prefs: []
  type: TYPE_NORMAL
- en: Fig. 153 Interconnection of two domains at an Internet eXchange Point[#](#id31
    "Link to this image")
  prefs: []
  type: TYPE_NORMAL
- en: In the early days of the Internet, domains would simply exchange all the routes
    they know to allow a host inside one domain to reach any host in the global Internet.
    However, in today’s highly commercial Internet, this is no longer true as interdomain
    routing mainly needs to take into account the economical relationships between
    the domains. Furthermore, while intradomain routing usually prefers some routes
    over others based on their technical merits (e.g. prefer route with the minimum
    number of hops, prefer route with the minimum delay, prefer high bandwidth routes
    over low bandwidth ones, etc) interdomain routing mainly deals with economical
    issues. For interdomain routing, the cost of using a route is often more important
    than the quality of the route measured by its delay or bandwidth.
  prefs: []
  type: TYPE_NORMAL
- en: There are different types of economical relationships that can exist between
    domains. Interdomain routing converts these relationships into peering relationships
    between domains that are connected via peering links.
  prefs: []
  type: TYPE_NORMAL
- en: The first category of peering relationship is the customer->provider relationship.
    Such a relationship is used when a customer domain pays an Internet Service Provider
    to be able to exchange packets with the global Internet over an interdomain link.
    A similar relationship is used when a small Internet Service Provider pays a larger
    Internet Service Provider to exchange packets with the global Internet.
  prefs: []
  type: TYPE_NORMAL
- en: '[![../_images/cust-prov.png](../Images/9bbaa4c6866576e40be5d34dc1cdfaa9.png)](../_images/cust-prov.png)'
  prefs: []
  type: TYPE_NORMAL
- en: Fig. 154 A simple Internet with peering relationships[#](#id32 "Link to this
    image")
  prefs: []
  type: TYPE_NORMAL
- en: 'To understand the customer->provider relationship, let us consider the simple
    internetwork shown in figure [Fig. 154](#fig-net-cust-prov). In this internetwork,
    AS7 is a stub domain that is connected to one provider : AS4. The contract between
    AS4 and AS7 allows a host inside AS7 to exchange packets with any host in the
    internetwork. To enable this exchange of packets, AS7 must know a route towards
    any domain and all the domains of the internetwork must know a route via AS4 that
    allows them to reach hosts inside AS7. From a routing perspective, the commercial
    contract between AS7 and AS4 leads to the following routes being exchanged :'
  prefs: []
  type: TYPE_NORMAL
- en: over a customer->provider relationship, the customer domain advertises to its
    provider its own prefixes and all the routes that it has learned from its own
    customers.
  prefs:
  - PREF_BQ
  - PREF_UL
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: over a provider->customer relationship, the provider advertises all the routes
    that it knows to its customer.
  prefs:
  - PREF_BQ
  - PREF_UL
  type: TYPE_NORMAL
- en: The second rule ensures that the customer domain receives a route towards all
    destinations that are reachable via its provider. The first rule allows the prefixes
    of the customer domain to be distributed throughout the Internet.
  prefs: []
  type: TYPE_NORMAL
- en: Coming back to figure [Fig. 154](#fig-net-cust-prov), AS4 advertises to its
    two providers AS1 and AS2 its own prefixes and the routes learned from its customer,
    AS7. On the other hand, AS4 advertises to AS7 all the routes that it knows.
  prefs: []
  type: TYPE_NORMAL
- en: The second type of peering relationship is the shared-cost peering relationship.
    Such a relationship usually does not involve a payment from one domain to the
    other in contrast with the customer->provider relationship. A shared-cost peering
    relationship is usually established between domains having a similar size and
    geographic coverage. For example, consider figure [Fig. 154](#fig-net-cust-prov).
    If AS3 and AS4 exchange many packets via AS1, they both need to pay AS1. A cheaper
    alternative for AS3 and AS4 would be to establish a shared-cost peering. Such
    a peering can be established at IXPs where both AS3 and AS4 are present or by
    using private peering links. This shared-cost peering should be used to exchange
    packets between hosts inside AS3 and hosts inside AS4. However, AS3 does not want
    to receive on the AS3-AS4 shared-cost peering links packets whose destination
    belongs to AS1 as AS3 would have to pay to send these packets to AS1.
  prefs: []
  type: TYPE_NORMAL
- en: From a routing perspective, over a shared-cost peering relationship a domain
    only advertises its internal routes/prefixes and the routes that it has learned
    from its customers. This restriction ensures that only packets destined to the
    local domain or one of its customers is received over the shared-cost peering
    relationship. This implies that the routes that have been learned from a provider
    or from another shared-cost peer is not advertised over a shared-cost peering
    relationship. This is motivated by economical reasons. If a domain were to advertise
    the routes that it learned from a provider over a shared-cost peering relationship
    that does not bring revenue, it would have allowed its shared-cost peer to use
    the link with its provider without any payment. If a domain were to advertise
    the routes it learned over a shared cost peering over another shared-cost peering
    relationship, it would have allowed these shared-cost peers to use its own network
    (which may span one or more continents) freely to exchange packets.
  prefs: []
  type: TYPE_NORMAL
- en: Finally, the last type of peering relationship is the sibling. Such a relationship
    is used when two domains exchange all their routes in both directions. In practice,
    such a relationship is only used between domains that belong to the same company.
  prefs: []
  type: TYPE_NORMAL
- en: 'These different types of relationships are implemented in the interdomain routing
    policies defined by each domain. The interdomain routing policy of a domain is
    composed of three main parts :'
  prefs: []
  type: TYPE_NORMAL
- en: the import filter that specifies, for each peering relationship, the routes
    that can be accepted from the neighboring domain (the non-acceptable routes are
    ignored and the domain never uses them to forward packets)
  prefs:
  - PREF_BQ
  - PREF_UL
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: the export filter that specifies, for each peering relationship, the routes
    that can be advertised to the neighboring domain
  prefs:
  - PREF_BQ
  - PREF_UL
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: the ranking algorithm that is used to select the best route among all the routes
    that the domain has received towards the same destination prefix
  prefs:
  - PREF_BQ
  - PREF_UL
  type: TYPE_NORMAL
- en: A domain’s import and export filters can be defined by using the Route Policy
    Specification Language (RPSL) specified in [**RFC 2622**](https://datatracker.ietf.org/doc/html/rfc2622.html)
    [[GAVE1999]](../bibliography.html#gave1999) . Some Internet Service Providers,
    notably in Europe, use RPSL to document [[5]](#fripedb) their import and export
    policies. Several tools help to easily convert a RPSL policy into router commands.
  prefs: []
  type: TYPE_NORMAL
- en: Figure [Fig. 155](#fig-bgp-rpsl) provides a simple example of import and export
    filters for two domains in a simple internetwork. In RPSL, the keyword ANY is
    used to replace any route from any domain. It is typically used by a provider
    to indicate that it announces all its routes to a customer over a provider->customer
    relationship. This is the case for AS4’s export policy. The example below clearly
    shows the difference between a provider->customer and a shared-cost peering relationship.
    AS4’s export filter indicates that it announces only its internal routes (AS4)
    and the routes learned from its clients (AS7) over its shared-cost peering with
    AS3, while it advertises all the routes that it uses (including the routes learned
    from AS3) to AS7.
  prefs: []
  type: TYPE_NORMAL
- en: '[![../_images/bgp-policies.png](../Images/9c1ff571215d2e7a9427e810eb9ba668.png)](../_images/bgp-policies.png)'
  prefs: []
  type: TYPE_NORMAL
- en: 'Fig. 155 Import and export policies[#](#id33 "Link to this image")  ## The
    Border Gateway Protocol[#](#the-border-gateway-protocol "Link to this heading")'
  prefs: []
  type: TYPE_NORMAL
- en: 'The Internet uses a single interdomain routing protocol : the Border Gateway
    Protocol (BGP). The current version of BGP is defined in [**RFC 4271**](https://datatracker.ietf.org/doc/html/rfc4271.html).
    BGP differs from the intradomain routing protocols that we have already discussed
    in several ways. First, BGP is a path-vector protocol. When a BGP router advertises
    a route towards a prefix, it announces the IP prefix and the interdomain path
    used to reach this prefix. From BGP’s point of view, each domain is identified
    by a unique Autonomous System (AS) number [[6]](#fasdomain) and the interdomain
    path contains the AS numbers of the transit domains that are used to reach the
    associated prefix. This interdomain path is called the AS Path. Thanks to these
    AS-Paths, BGP does not suffer from the count-to-infinity problems that affect
    distance vector routing protocols. Furthermore, the AS-Path can be used to implement
    some routing policies. Another difference between BGP and the intradomain routing
    protocols is that a BGP router does not send the entire contents of its routing
    table to its neighbors regularly. Given the size of the global Internet, routers
    would be overloaded by the number of BGP messages that they would need to process.
    BGP uses incremental updates, i.e. it only announces the routes that have changed
    to its neighbors.'
  prefs: []
  type: TYPE_NORMAL
- en: Figure [Fig. 156](#fig-bgp-simple-example) shows a simple example of the BGP
    routes that are exchanged between domains. In this example, prefix 2001:db8:cafe::/48
    is announced by AS1. AS1 advertises a BGP route towards this prefix to AS2. The
    AS-Path of this route indicates that AS1 is the originator of the prefix. When
    AS4 receives the BGP route from AS1, it re-announces it to AS2 and adds its AS
    number to the AS-Path. AS2 has learned two routes towards prefix 2001:db8:cafe::/48.
    It compares the two routes and prefers the route learned from AS4 based on its
    own ranking algorithm. AS2 advertises to AS5 a route towards 2001:db8:cafe::/48
    with its AS-Path set to AS2:AS4:AS1. Thanks to the AS-Path, AS5 knows that if
    it sends a packet towards 2001:db8:cafe::/48 the packet first passes through AS2,
    then through AS4 before reaching its destination inside AS1.
  prefs: []
  type: TYPE_NORMAL
- en: '![../_images/bgp-example.svg](../Images/56e7d7a0ece44c03599c9703f7a1ad4a.png)'
  prefs: []
  type: TYPE_IMG
- en: Fig. 156 Simple exchange of BGP routes[#](#id34 "Link to this image")
  prefs: []
  type: TYPE_NORMAL
- en: BGP routers exchange routes over BGP sessions. A BGP session is established
    between two routers belonging to two different domains that are directly connected.
    As explained earlier, the physical connection between the two routers can be implemented
    as a private peering link or over an Internet eXchange Point. A BGP session between
    two adjacent routers runs above a TCP connection (the default BGP port is 179).
    In contrast with intradomain routing protocols that exchange IP packets or UDP
    segments, BGP runs above TCP because TCP ensures a reliable delivery of the BGP
    messages sent by each router without forcing the routers to implement acknowledgments,
    checksums, etc. Furthermore, the two routers consider the peering link to be up
    as long as the BGP session and the underlying TCP connection remain up [[7]](#flifetimebgp).
    The two endpoints of a BGP session are called BGP peers.
  prefs: []
  type: TYPE_NORMAL
- en: '[![../_images/bgp-peering.svg](../Images/e2885e7697e16c061ff1e144ac74d408.png)](../_images/bgp-peering.svg)'
  prefs: []
  type: TYPE_NORMAL
- en: Fig. 157 A BGP peering session between two directly connected routers[#](#id35
    "Link to this image")
  prefs: []
  type: TYPE_NORMAL
- en: In practice, to establish a BGP session between routers R1 and R2 in the figure
    above, the network administrator of AS3 must first configure on R1 the IP address
    of R2 on the R1-R2 link and the AS number of R2. Router R1 then regularly tries
    to establish the BGP session with R2. R2 only agrees to establish the BGP session
    with R1 once it has been configured with the IP address of R1 and its AS number.
    For security reasons, a router never establishes a BGP session that has not been
    manually configured on the router.
  prefs: []
  type: TYPE_NORMAL
- en: 'The BGP protocol [**RFC 4271**](https://datatracker.ietf.org/doc/html/rfc4271.html)
    defines several types of messages that can be exchanged over a BGP session :'
  prefs: []
  type: TYPE_NORMAL
- en: 'OPEN : this message is sent as soon as the TCP connection between the two routers
    has been established. It initializes the BGP session and allows the negotiation
    of some options. Details about this message may be found in [**RFC 4271**](https://datatracker.ietf.org/doc/html/rfc4271.html).'
  prefs:
  - PREF_BQ
  - PREF_UL
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: 'NOTIFICATION : this message is used to terminate a BGP session, usually because
    an error has been detected by the BGP peer. A router that sends or receives a
    NOTIFICATION message immediately shutdowns the corresponding BGP session.'
  prefs:
  - PREF_BQ
  - PREF_UL
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: 'UPDATE: this message is used to advertise new or modified routes or to withdraw
    previously advertised routes.'
  prefs:
  - PREF_BQ
  - PREF_UL
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: 'KEEPALIVE : this message is used to ensure a regular exchange of messages on
    the BGP session, even when no route changes. When a BGP router has not sent an
    UPDATE message during the last 30 seconds, it shall send a KEEPALIVE message to
    confirm to the other peer that it is still up. If a peer does not receive any
    BGP message during a period of 90 seconds [[8]](#fdefaultkeepalive), the BGP session
    is considered to be down and all the routes learned over this session are withdrawn.'
  prefs:
  - PREF_BQ
  - PREF_UL
  type: TYPE_NORMAL
- en: 'As explained earlier, BGP relies on incremental updates. This implies that
    when a BGP session starts, each router first sends BGP UPDATE messages to advertise
    to the other peer all the exportable routes that it knows. Once all these routes
    have been advertised, the BGP router only sends BGP UPDATE messages about a prefix
    if the route is new, one of its attributes has changed or the route became unreachable
    and must be withdrawn. The BGP UPDATE message allows BGP routers to efficiently
    exchange such information while minimizing the number of bytes exchanged. Each
    UPDATE message contains :'
  prefs: []
  type: TYPE_NORMAL
- en: a list of IP prefixes that are withdrawn
  prefs:
  - PREF_BQ
  - PREF_UL
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: a list of IP prefixes that are (re-)advertised
  prefs:
  - PREF_BQ
  - PREF_UL
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: the set of attributes (e.g. AS-Path) associated to the advertised prefixes
  prefs:
  - PREF_BQ
  - PREF_UL
  type: TYPE_NORMAL
- en: 'In the remainder of this chapter, and although all routing information is exchanged
    using BGP UPDATE messages, we assume for simplicity that a BGP message contains
    only information about one prefix and we use the words :'
  prefs: []
  type: TYPE_NORMAL
- en: Withdraw message to indicate a BGP UPDATE message containing one route that
    is withdrawn
  prefs:
  - PREF_BQ
  - PREF_UL
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: Update message to indicate a BGP UPDATE containing a new or updated route towards
    one destination prefix with its attributes
  prefs:
  - PREF_BQ
  - PREF_UL
  type: TYPE_NORMAL
- en: From a conceptual point of view, a BGP router connected to N BGP peers, can
    be described as being composed of four parts as shown in the figure below.
  prefs: []
  type: TYPE_NORMAL
- en: '[![../_images/bgp-router.png](../Images/0079025668f84e1a91f1e4196c6e5332.png)](../_images/bgp-router.png)'
  prefs: []
  type: TYPE_NORMAL
- en: Fig. 158 Organization of a BGP router[#](#id36 "Link to this image")
  prefs: []
  type: TYPE_NORMAL
- en: 'In this figure, the router receives BGP messages on the left part of the figure,
    processes these messages and possibly sends BGP messages on the right part of
    the figure. A BGP router contains three important data structures :'
  prefs: []
  type: TYPE_NORMAL
- en: the Adj-RIB-In contains the BGP routes that have been received from each BGP
    peer. The routes in the Adj-RIB-In are filtered by the import filter before being
    placed in the BGP-Loc-RIB. There is one import filter per BGP peer.
  prefs:
  - PREF_BQ
  - PREF_UL
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: the Local Routing Information Base (Loc-RIB) contains all the routes that are
    considered as acceptable by the router. The Loc-RIB may contain several routes,
    learned from different BGP peers, towards the same destination prefix.
  prefs:
  - PREF_BQ
  - PREF_UL
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: the Forwarding Information Base (FIB) is used by the dataplane to forward packets
    towards their destination. The FIB contains, for each destination, the best route
    that has been selected by the BGP decision process. This decision process is an
    algorithm that selects, for each destination prefix, the best route according
    to the router’s ranking algorithm that is part of its policy.
  prefs:
  - PREF_BQ
  - PREF_UL
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: the Adj-RIB-Out contains the BGP routes that have been advertised to each BGP
    peer. The Adj-RIB-Out for a given peer is built by applying the peer’s export
    filter on the routes that have been installed in the FIB. There is one export
    filter per BGP peer. For this reason, the Adj-RIB-Out of a peer may contain different
    routes than the Adj-RIB-Out of another peer.
  prefs:
  - PREF_BQ
  - PREF_UL
  type: TYPE_NORMAL
- en: When a BGP session starts, the routers first exchange OPEN messages to negotiate
    the options that apply throughout the entire session. Then, each router extracts
    from its FIB the routes to be advertised to the peer. It is important to note
    that, for each known destination prefix, a BGP router can only advertise to a
    peer the route that it has itself installed inside its FIB. The routes that are
    advertised to a peer must pass the peer’s export filter. The export filter is
    a set of rules that define which routes can be advertised over the corresponding
    session, possibly after having modified some of its attributes. One export filter
    is associated to each BGP session. For example, on a shared-cost peering, the
    export filter only selects the internal routes and the routes that have been learned
    from a customer. The pseudo-code below shows the initialization of a BGP session.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  prefs: []
  type: TYPE_PRE
- en: In the above pseudo-code, the build_BGP_update(d) procedure extracts from the
    BGP Loc-RIB the best path towards destination d (i.e. the route installed in the
    FIB) and prepares the corresponding BGP UPDATE message. This message is then passed
    to the export filter that returns None if the route cannot be advertised to the
    peer or the (possibly modified) BGP UPDATE message to be advertised. BGP routers
    allow network administrators to specify very complex export filters, see e.g.
    [[WMS2004]](../bibliography.html#wms2004). A simple export filter that implements
    the equivalent of split horizon is shown below.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE1]'
  prefs: []
  type: TYPE_PRE
- en: At this point, the remote router has received all the exportable BGP routes.
    After this initial exchange, the router only sends BGP UPDATE messages when there
    is a change (addition of a route, removal of a route or change in the attributes
    of a route) in one of these exportable routes. Such a change can happen when the
    router receives a BGP message. The pseudo-code below summarizes the processing
    of these BGP messages.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE2]'
  prefs: []
  type: TYPE_PRE
- en: When a BGP message is received, the router first applies the peer’s import filter
    to verify whether the message is acceptable or not. If the message is not acceptable,
    the processing stops. The pseudo-code below shows a simple import filter. This
    import filter accepts all routes, except those that already contain the local
    AS in their AS-Path. If such a route was used, it would cause a routing loop.
    Another example of an import filter would be a filter used by an Internet Service
    Provider on a session with a customer to only accept routes towards the IP prefixes
    assigned to the customer by the provider. On real routers, import filters can
    be much more complex and some import filters modify the attributes of the received
    BGP UPDATE [[WMS2004]](../bibliography.html#wms2004) .
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE3]'
  prefs: []
  type: TYPE_PRE
- en: Note
  prefs: []
  type: TYPE_NORMAL
- en: The bogon filters
  prefs: []
  type: TYPE_NORMAL
- en: Another example of frequently used import filters are the filters that Internet
    Service Providers use to ignore bogon routes. In the ISP community, a bogon route
    is a route that should not be advertised on the global Internet. Typical examples
    include the documentation IPv6 prefix (2001:db8::/32 used for most examples in
    this book), the loopback address (::1/128) or the IPv6 prefixes that have not
    yet been allocated by IANA. A well managed BGP router should ensure that it never
    advertises bogons on the global Internet. Detailed information about these bogons
    may be found in [[IMHM2013]](../bibliography.html#imhm2013).
  prefs: []
  type: TYPE_NORMAL
- en: If the import filter accepts the BGP message, the pseudo-code distinguishes
    two cases. If this is an Update message for prefix p, this can be a new route
    for this prefix or a modification of the route’s attributes. The router first
    retrieves from its RIB the best route towards prefix p. Then, the new route is
    inserted in the RIB and the BGP decision process is run to find whether the best
    route towards destination p changes. A BGP message only needs to be sent to the
    router’s peers if the best route has changed. For each peer, the router applies
    the export filter to verify whether the route can be advertised. If yes, the filtered
    BGP message is sent. Otherwise, a Withdraw message is sent. When the router receives
    a Withdraw message, it also verifies whether the removal of the route from its
    RIB caused its best route towards this prefix to change. It should be noted that,
    depending on the content of the RIB and the export filters, a BGP router may need
    to send a Withdraw message to a peer after having received an Update message from
    another peer and conversely.
  prefs: []
  type: TYPE_NORMAL
- en: Let us now discuss in more detail the operation of BGP in an IPv6 network. For
    this, let us consider the simple network composed of three routers located in
    three different ASes and shown in the figure below.
  prefs: []
  type: TYPE_NORMAL
- en: '[![../_images/bgp-nexthop.svg](../Images/e4d6965066e9e8670bd2ee7036f03d88.png)](../_images/bgp-nexthop.svg)'
  prefs: []
  type: TYPE_NORMAL
- en: Fig. 159 Utilization of the BGP nexthop attribute[#](#id37 "Link to this image")
  prefs: []
  type: TYPE_NORMAL
- en: 'This network contains three routers : R1, R2 and R3. Each router is attached
    to a local IPv6 subnet that it advertises using BGP. There are two BGP sessions,
    one between R1 and R2 and the second between R2 and R3. A /127 subnet is used
    on each interdomain link (2001:db8::4/127 on R1-R2 and 2001:db8::0/127 on R2-R3)
    in conformance with the latest recommendation [**RFC 6164**](https://datatracker.ietf.org/doc/html/rfc6164.html).
    The BGP sessions run above TCP connections established between the neighboring
    routers (e.g. 2001:db8::5 - 2001:db8::6 for the R1-R2 session).'
  prefs: []
  type: TYPE_NORMAL
- en: 'Let us assume that the R1-R2 BGP session is the first to be established. A
    BGP Update message sent on such a session contains three fields :'
  prefs: []
  type: TYPE_NORMAL
- en: the advertised prefix
  prefs:
  - PREF_BQ
  - PREF_UL
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: the BGP nexthop
  prefs:
  - PREF_BQ
  - PREF_UL
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: the attributes including the AS-Path
  prefs:
  - PREF_BQ
  - PREF_UL
  type: TYPE_NORMAL
- en: We use the notation U(prefix, nexthop, attributes) to represent such a BGP Update
    message in this section. Similarly, W(prefix) represents a BGP withdraw for the
    specified prefix. Once the R1-R2 session has been established, R1 sends U(2001:db8:1234::/48,2001:db8::5,AS10)
    to R2 and R2 sends U(2001:db8:5678:/48,2001:db8::6,AS20). At this point, R1 can
    reach 2001:db8:5678::/48 via 2001:db8::6 and R2 can reach 2001:db8:1234::/48 via
    2001:db8::5.
  prefs: []
  type: TYPE_NORMAL
- en: 'Once the R2-R3 has been established, R3 sends U(2001:db8:acbd::/48,2001:db8::2,AS30).
    R2 announces on the R2-R3 session all the routes inside its RIB. It thus sends
    to R3 : U(2001:db8:1234::/48,2001:db8::1,AS20:AS10) and U(2001:db8:5678::/48,2001:db8::1,AS20).
    Note that when R2 advertises the route that it learned from R1, it updates the
    BGP nexthop and adds its AS number to the AS-Path. R2 also sends U(2001:db8:abcd::48,2001:db8::6,AS20:AS30)
    to R1 on the R1-R3 session. At this point, all BGP routes have been exchanged
    and all routers can reach 2001:db8::1234/48, 2001:db8:5678::/48 and 2001:db8:abcd::/48.'
  prefs: []
  type: TYPE_NORMAL
- en: If the link between R2 and R3 fails, R3 detects the failure as it did not receive
    KEEPALIVE messages recently from R2. At this time, R3 removes from its RIB all
    the routes learned over the R2-R3 BGP session. R2 also removes from its RIB the
    routes learned from R3. R2 also sends W(2001:db8:acbd::/48) to R1 over the R1-R3
    BGP session since it does not have a route anymore towards this prefix.
  prefs: []
  type: TYPE_NORMAL
- en: Note
  prefs: []
  type: TYPE_NORMAL
- en: Origin of the routes advertised by a BGP router
  prefs: []
  type: TYPE_NORMAL
- en: 'A frequent practical question about the operation of BGP is how a BGP router
    decides to originate or advertise a route for the first time. In practice, this
    occurs in two situations :'
  prefs: []
  type: TYPE_NORMAL
- en: the router has been manually configured by the network operator to always advertise
    one or several routes on a BGP session. For example, on the BGP session between
    UCLouvain and its provider, [belnet](https://www.belnet.be) , UCLouvain’s router
    always advertises the 2001:6a8:3080/48 IPv6 prefix assigned to the campus network
  prefs:
  - PREF_BQ
  - PREF_UL
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: the router has been configured by the network operator to advertise over its
    BGP session some of the routes that it learns with its intradomain routing protocol.
    For example, an enterprise router may advertise over a BGP session with its provider
    the routes to remote sites when these routes are reachable and advertised by the
    intradomain routing protocol
  prefs:
  - PREF_BQ
  - PREF_UL
  type: TYPE_NORMAL
- en: The first solution is the most frequent. Advertising routes learned from an
    intradomain routing protocol is not recommended, this is because if the route
    flaps [[9]](#fflap), this would cause a large number of BGP messages being exchanged
    in the global Internet.
  prefs: []
  type: TYPE_NORMAL
- en: '### The BGP decision process[#](#the-bgp-decision-process "Link to this heading")'
  prefs: []
  type: TYPE_NORMAL
- en: Besides the import and export filters, a key difference between BGP and the
    intradomain routing protocols is that each domain can define its own ranking algorithm
    to determine which route is chosen to forward packets when several routes have
    been learned towards the same prefix. This ranking depends on several BGP attributes
    that can be attached to a BGP route.
  prefs: []
  type: TYPE_NORMAL
- en: The first BGP attribute that is used to rank BGP routes is the local-preference
    (local-pref) attribute. This attribute is an unsigned integer that is attached
    to each BGP route received over an eBGP session by the associated import filter.
  prefs: []
  type: TYPE_NORMAL
- en: When comparing routes towards the same destination prefix, a BGP router always
    prefers the routes with the highest local-pref. If the BGP router knows several
    routes with the same local-pref, it prefers among the routes having this local-pref
    the ones with the shortest AS-Path.
  prefs: []
  type: TYPE_NORMAL
- en: The local-pref attribute is often used to prefer some routes over others.
  prefs: []
  type: TYPE_NORMAL
- en: A common utilization of local-pref is to support backup links. Consider the
    situation depicted in the figure below. AS1 would always like to use the high
    bandwidth link to send and receive packets via AS2 and only use the backup link
    upon failure of the primary one.
  prefs: []
  type: TYPE_NORMAL
- en: '[![../_images/bgp-backup.svg](../Images/a3485a4ec7385b94aecb7b585e809d0b.png)](../_images/bgp-backup.svg)'
  prefs: []
  type: TYPE_NORMAL
- en: Fig. 160 How to create a backup link with BGP ?[#](#id38 "Link to this image")
  prefs: []
  type: TYPE_NORMAL
- en: As BGP routers always prefer the routes with the highest local-pref attribute,
    this policy can be implemented using the following import filter on R1
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE4]'
  prefs: []
  type: TYPE_PRE
- en: With this import filter, all the BGP routes learned from RB over the high bandwidth
    links are preferred over the routes learned over the backup link. If the primary
    link fails, the corresponding routes are removed from R1’s RIB and R1 uses the
    route learned from RA. R1 reuses the routes via RB as soon as they are advertised
    by RB once the R1-RB link comes back.
  prefs: []
  type: TYPE_NORMAL
- en: The import filter above modifies the selection of the BGP routes inside AS1.
    Thus, it influences the route followed by the packets forwarded by AS1. In addition
    to using the primary link to send packets, AS1 would like to receive its packets
    via the high bandwidth link. For this, AS2 also needs to set the local-pref attribute
    in its import filter.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE5]'
  prefs: []
  type: TYPE_PRE
- en: Sometimes, the local-pref attribute is used to prefer a cheap link compared
    to a more expensive one. For example, in the network below, AS1 could wish to
    send and receive packets mainly via its interdomain link with AS4.
  prefs: []
  type: TYPE_NORMAL
- en: '[![../_images/bgp-prefer.svg](../Images/a6ae4372991a589dfd16713f3fbf28dc.png)](../_images/bgp-prefer.svg)'
  prefs: []
  type: TYPE_NORMAL
- en: Fig. 161 How to prefer a cheap link over an more expensive one ?[#](#id39 "Link
    to this image")
  prefs: []
  type: TYPE_NORMAL
- en: AS1 can install the following import filter on R1 to ensure that it always sends
    packets via R2 when it has learned a route via AS2 and another via AS4.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE6]'
  prefs: []
  type: TYPE_PRE
- en: However, this import filter does not influence how AS3 , for example, prefers
    some routes over others. If the link between AS3 and AS2 is less expensive than
    the link between AS3 and AS4, AS3 could send all its packets via AS2 and AS1 would
    receive packets over its expensive link. An important point to remember about
    local-pref is that it can be used to prefer some routes over others to send packets,
    but it has no influence on the routes followed by received packets.
  prefs: []
  type: TYPE_NORMAL
- en: 'Another important utilization of the local-pref attribute is to support the
    customer->provider and shared-cost peering relationships. From an economic point
    of view, there is an important difference between these three types of peering
    relationships. A domain usually earns money when it sends packets over a provider->customer
    relationship. On the other hand, it must pay its provider when it sends packets
    over a customer->provider relationship. Using a shared-cost peering to send packets
    is usually neutral from an economic perspective. To take into account these economic
    issues, domains usually configure the import filters on their routers as follows
    :'
  prefs: []
  type: TYPE_NORMAL
- en: insert a high local-pref attribute in the routes learned from a customer
  prefs:
  - PREF_BQ
  - PREF_UL
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: insert a medium local-pref attribute in the routes learned over a shared-cost
    peering
  prefs:
  - PREF_BQ
  - PREF_UL
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: insert a low local-pref attribute in the routes learned from a provider
  prefs:
  - PREF_BQ
  - PREF_UL
  type: TYPE_NORMAL
- en: With such an import filter, the routers of a domain always prefer to reach destinations
    via their customers whenever such a route exists. Otherwise, they prefer to use
    shared-cost peering relationships and they only send packets via their providers
    when they do not know any alternate route. A consequence of setting the local-pref
    attribute like this is that Internet paths are often asymmetrical. Consider for
    example the internetwork shown in the figure below.
  prefs: []
  type: TYPE_NORMAL
- en: '[![../_images/asymetry.svg](../Images/0a126e385db1ba6a60851408e8964db3.png)](../_images/asymetry.svg)'
  prefs: []
  type: TYPE_NORMAL
- en: Fig. 162 Asymmetry of Internet paths[#](#id40 "Link to this image")
  prefs: []
  type: TYPE_NORMAL
- en: Consider in this internetwork the routes available inside AS1 to reach AS5.
    AS1 learns the AS4:AS6:AS7:AS5 path from AS4, the AS3:AS8:AS5 path from AS3 and
    the AS2:AS5 path from AS2. The first path is chosen since it was learned from
    a customer. AS5 on the other hand receives three paths towards AS1 via its providers.
    It may select any of these paths to reach AS1 , depending on how it prefers one
    provider over the others.
  prefs: []
  type: TYPE_NORMAL
- en: BGP convergence[#](#bgp-convergence "Link to this heading")
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: In the previous sections, we have explained the operation of BGP routers. Compared
    to intradomain routing protocols, a key feature of BGP is its ability to support
    interdomain routing policies that are defined by each domain as its import and
    export filters and ranking process. A domain can define its own routing policies
    and router vendors have implemented many configuration tweaks to support complex
    routing policies. However, the routing policy chosen by a domain may interfere
    with the routing policy chosen by another domain. To understand this issue, let
    us first consider the simple internetwork shown below.
  prefs: []
  type: TYPE_NORMAL
- en: '[![../_images/disagree.svg](../Images/e0d8fea96abc42f780dccaaf6f640d03.png)](../_images/disagree.svg)'
  prefs: []
  type: TYPE_NORMAL
- en: Fig. 163 The disagree internetwork[#](#id41 "Link to this image")
  prefs: []
  type: TYPE_NORMAL
- en: 'In this internetwork, we focus on the route towards 2001:db8::1234/48 which
    is advertised by AS1. Let us also assume that AS3 (resp. AS4) prefers, e.g. for
    economic reasons, a route learned from AS4 (AS3) over a route learned from AS1.
    When AS1 sends U(2001:db8::1234/48,AS1) to AS3 and AS4, three sequences of exchanges
    of BGP messages are possible :'
  prefs: []
  type: TYPE_NORMAL
- en: AS3 sends first U(2001:db8:1234/48,AS3:AS1) to AS4. AS4 has learned two routes
    towards 2001:db8:1234/48. It runs its BGP decision process and selects the route
    via AS3 and does not advertise a route to AS3
  prefs:
  - PREF_BQ
  - PREF_OL
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: AS4 first sends U(2001:db8:1234/48,AS4:AS1) to AS3. AS3 has learned two routes
    towards 2001:db8:1234/48. It runs its BGP decision process and selects the route
    via AS4 and does not advertise a route to AS4
  prefs:
  - PREF_BQ
  - PREF_OL
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: AS3 sends U(2001:db8:1234/48,AS3:AS1) to AS4 and, at the same time, AS4 sends
    U(2001:db8:1234/48,AS4:AS1). AS3 prefers the route via AS4 and thus sends W(2001:db8:1234/48)
    to AS4. In the mean time, AS4 prefers the route via AS3 and thus sends W(2001:db8:1234/48)
    to AS3. Upon reception of the BGP Withdraws, AS3 and AS4 only know the direct
    route towards 2001:db8:1234/48. AS3 (resp. AS4) sends U(2001:db8:1234/48,AS3:AS1)
    (resp. U(2001:db8:1234/48,AS4:AS1)) to AS4 (resp. AS3). AS3 and AS4 could in theory
    continue to exchange BGP messages for ever. In practice, one of them sends one
    message faster than the other and BGP converges.
  prefs:
  - PREF_BQ
  - PREF_OL
  type: TYPE_NORMAL
- en: The example above has shown that the routes selected by BGP routers may sometimes
    depend on the ordering of the BGP messages that are exchanged. Other similar scenarios
    may be found in [**RFC 4264**](https://datatracker.ietf.org/doc/html/rfc4264.html).
  prefs: []
  type: TYPE_NORMAL
- en: From an operational perspective, the above configuration is annoying since the
    network operators cannot easily predict which paths are chosen. Unfortunately,
    there are even more annoying BGP configurations. For example, let us consider
    the configuration below which is often named Bad Gadget [[GW1999]](../bibliography.html#gw1999)
  prefs: []
  type: TYPE_NORMAL
- en: '[![../_images/bad-gadget.svg](../Images/98a26037d12a6cb60b64faf1e25a4470.png)](../_images/bad-gadget.svg)'
  prefs: []
  type: TYPE_NORMAL
- en: Fig. 164 The bad gadget internetwork[#](#id42 "Link to this image")
  prefs: []
  type: TYPE_NORMAL
- en: 'In this internetwork, there are four ASes. AS0 advertises one route towards
    one prefix and we only analyze the routes towards this prefix. The routing preferences
    of AS1, AS3 and AS4 are the following :'
  prefs: []
  type: TYPE_NORMAL
- en: AS1 prefers the path AS3:AS0 over all other paths
  prefs:
  - PREF_BQ
  - PREF_UL
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: AS3 prefers the path AS4:AS0 over all other paths
  prefs:
  - PREF_BQ
  - PREF_UL
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: AS4 prefers the path AS1:AS0 over all other paths
  prefs:
  - PREF_BQ
  - PREF_UL
  type: TYPE_NORMAL
- en: 'AS0 sends U(p,AS0) to AS1, AS3 and AS4. As this is the only route known by
    AS1, AS3 and AS4 towards p, they all select the direct path. Let us now consider
    one possible exchange of BGP messages :'
  prefs: []
  type: TYPE_NORMAL
- en: AS1 sends U(p, AS1:AS0) to AS3 and AS4. AS4 selects the path via AS1 since this
    is its preferred path. AS3 still uses the direct path.
  prefs:
  - PREF_BQ
  - PREF_OL
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: AS4 advertises U(p,AS4:AS1:AS0) to AS3.
  prefs:
  - PREF_BQ
  - PREF_OL
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: AS3 sends U(p, AS3:AS0) to AS1 and AS4. AS1 selects the path via AS3 since this
    is its preferred path. AS4 still uses the path via AS1.
  prefs:
  - PREF_BQ
  - PREF_OL
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: As AS1 has changed its path, it sends U(p,AS1:AS3:AS0) to AS4 and W(p) to AS3
    since its new path is via AS3. AS4 switches back to the direct path.
  prefs:
  - PREF_BQ
  - PREF_OL
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: AS4 sends U(p,AS4:AS0) to AS1 and AS3. AS3 prefers the path via AS4.
  prefs:
  - PREF_BQ
  - PREF_OL
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: AS3 sends U(p,AS3:AS4:AS0) to AS1 and W(p) to AS4. AS1 switches back to the
    direct path and we are back at the first step.
  prefs:
  - PREF_BQ
  - PREF_OL
  type: TYPE_NORMAL
- en: This example shows that the convergence of BGP is unfortunately not always guaranteed
    as some interdomain routing policies may interfere with each other in complex
    ways. [[GW1999]](../bibliography.html#gw1999) have shown that checking for global
    convergence is either NP-complete or NP-hard. See [[GSW2002]](../bibliography.html#gsw2002)
    for a more detailed discussion.
  prefs: []
  type: TYPE_NORMAL
- en: 'Fortunately, there are some operational guidelines [[GR2001]](../bibliography.html#gr2001)
    [[GGR2001]](../bibliography.html#ggr2001) that can guarantee BGP convergence in
    the global Internet. To ensure that BGP will converge, these guidelines consider
    that there are two types of peering relationships : customer->provider and shared-cost.
    In this case, BGP convergence is guaranteed provided that the following conditions
    are fulfilled :'
  prefs: []
  type: TYPE_NORMAL
- en: The topology composed of all the directed customer->provider peering links is
    a graph that does not contain any cycle
  prefs:
  - PREF_BQ
  - PREF_OL
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: An AS always prefers a route received from a customer over a route received
    from a shared-cost peer or a provider.
  prefs:
  - PREF_BQ
  - PREF_OL
  type: TYPE_NORMAL
- en: The first guideline implies that the provider of the provider of ASx cannot
    be a customer of ASx. Such a relationship would not make sense from an economic
    perspective as it would imply circular payments. Furthermore, providers are usually
    larger than customers.
  prefs: []
  type: TYPE_NORMAL
- en: The second guideline also corresponds to economic preferences. Since a provider
    earns money when sending packets to one of its customers, it makes sense to prefer
    such customer learned routes over routes learned from providers. [[GR2001]](../bibliography.html#gr2001)
    also shows that BGP convergence is guaranteed even if an AS associates the same
    preference to routes learned from a shared-cost peer and routes learned from a
    customer.
  prefs: []
  type: TYPE_NORMAL
- en: From a theoretical perspective, these guidelines should be verified automatically
    to ensure that BGP will always converge in the global Internet. However, such
    a verification cannot be performed in practice because this would force all domains
    to disclose their routing policies (and few are willing to do so) and furthermore
    the problem is known to be NP-hard [GW1999].
  prefs: []
  type: TYPE_NORMAL
- en: In practice, researchers and operators expect that these guidelines are verified
    [[10]](#fgranularity) in most domains. Thanks to the large amount of BGP data
    that has been collected by operators and researchers [[11]](#fbgpdata), several
    studies have analyzed the AS-level topology of the Internet. [[SARK2002]](../bibliography.html#sark2002)
    is one of the first analysis. More recent studies include [[COZ2008]](../bibliography.html#coz2008)
    and [[DKF+2007]](../bibliography.html#dkf-2007)
  prefs: []
  type: TYPE_NORMAL
- en: Based on these studies and [[ATLAS2009]](../bibliography.html#atlas2009), the
    AS-level Internet topology can be summarized as shown in the figure below.
  prefs: []
  type: TYPE_NORMAL
- en: '[![../_images/bgp-hierarchy.svg](../Images/7ed75e3a3085ea745ef374995877c629.png)](../_images/bgp-hierarchy.svg)'
  prefs: []
  type: TYPE_NORMAL
- en: Fig. 165 The layered structure of the global Internet[#](#id43 "Link to this
    image")
  prefs: []
  type: TYPE_NORMAL
- en: The domains on the Internet can be divided in about four categories according
    to their role and their position in the AS-level topology.
  prefs: []
  type: TYPE_NORMAL
- en: Due to this organization of the Internet and due to the BGP decision process,
    most AS-level paths on the Internet have a length of 3-5 AS hops.
  prefs: []
  type: TYPE_NORMAL
- en: 'Footnotes  ## The Border Gateway Protocol[#](#the-border-gateway-protocol "Link
    to this heading")'
  prefs: []
  type: TYPE_NORMAL
- en: 'The Internet uses a single interdomain routing protocol : the Border Gateway
    Protocol (BGP). The current version of BGP is defined in [**RFC 4271**](https://datatracker.ietf.org/doc/html/rfc4271.html).
    BGP differs from the intradomain routing protocols that we have already discussed
    in several ways. First, BGP is a path-vector protocol. When a BGP router advertises
    a route towards a prefix, it announces the IP prefix and the interdomain path
    used to reach this prefix. From BGP’s point of view, each domain is identified
    by a unique Autonomous System (AS) number [[6]](#fasdomain) and the interdomain
    path contains the AS numbers of the transit domains that are used to reach the
    associated prefix. This interdomain path is called the AS Path. Thanks to these
    AS-Paths, BGP does not suffer from the count-to-infinity problems that affect
    distance vector routing protocols. Furthermore, the AS-Path can be used to implement
    some routing policies. Another difference between BGP and the intradomain routing
    protocols is that a BGP router does not send the entire contents of its routing
    table to its neighbors regularly. Given the size of the global Internet, routers
    would be overloaded by the number of BGP messages that they would need to process.
    BGP uses incremental updates, i.e. it only announces the routes that have changed
    to its neighbors.'
  prefs: []
  type: TYPE_NORMAL
- en: Figure [Fig. 156](#fig-bgp-simple-example) shows a simple example of the BGP
    routes that are exchanged between domains. In this example, prefix 2001:db8:cafe::/48
    is announced by AS1. AS1 advertises a BGP route towards this prefix to AS2. The
    AS-Path of this route indicates that AS1 is the originator of the prefix. When
    AS4 receives the BGP route from AS1, it re-announces it to AS2 and adds its AS
    number to the AS-Path. AS2 has learned two routes towards prefix 2001:db8:cafe::/48.
    It compares the two routes and prefers the route learned from AS4 based on its
    own ranking algorithm. AS2 advertises to AS5 a route towards 2001:db8:cafe::/48
    with its AS-Path set to AS2:AS4:AS1. Thanks to the AS-Path, AS5 knows that if
    it sends a packet towards 2001:db8:cafe::/48 the packet first passes through AS2,
    then through AS4 before reaching its destination inside AS1.
  prefs: []
  type: TYPE_NORMAL
- en: '![../_images/bgp-example.svg](../Images/56e7d7a0ece44c03599c9703f7a1ad4a.png)'
  prefs: []
  type: TYPE_IMG
- en: Fig. 156 Simple exchange of BGP routes[#](#id34 "Link to this image")
  prefs: []
  type: TYPE_NORMAL
- en: BGP routers exchange routes over BGP sessions. A BGP session is established
    between two routers belonging to two different domains that are directly connected.
    As explained earlier, the physical connection between the two routers can be implemented
    as a private peering link or over an Internet eXchange Point. A BGP session between
    two adjacent routers runs above a TCP connection (the default BGP port is 179).
    In contrast with intradomain routing protocols that exchange IP packets or UDP
    segments, BGP runs above TCP because TCP ensures a reliable delivery of the BGP
    messages sent by each router without forcing the routers to implement acknowledgments,
    checksums, etc. Furthermore, the two routers consider the peering link to be up
    as long as the BGP session and the underlying TCP connection remain up [[7]](#flifetimebgp).
    The two endpoints of a BGP session are called BGP peers.
  prefs: []
  type: TYPE_NORMAL
- en: '[![../_images/bgp-peering.svg](../Images/e2885e7697e16c061ff1e144ac74d408.png)](../_images/bgp-peering.svg)'
  prefs: []
  type: TYPE_NORMAL
- en: Fig. 157 A BGP peering session between two directly connected routers[#](#id35
    "Link to this image")
  prefs: []
  type: TYPE_NORMAL
- en: In practice, to establish a BGP session between routers R1 and R2 in the figure
    above, the network administrator of AS3 must first configure on R1 the IP address
    of R2 on the R1-R2 link and the AS number of R2. Router R1 then regularly tries
    to establish the BGP session with R2. R2 only agrees to establish the BGP session
    with R1 once it has been configured with the IP address of R1 and its AS number.
    For security reasons, a router never establishes a BGP session that has not been
    manually configured on the router.
  prefs: []
  type: TYPE_NORMAL
- en: 'The BGP protocol [**RFC 4271**](https://datatracker.ietf.org/doc/html/rfc4271.html)
    defines several types of messages that can be exchanged over a BGP session :'
  prefs: []
  type: TYPE_NORMAL
- en: 'OPEN : this message is sent as soon as the TCP connection between the two routers
    has been established. It initializes the BGP session and allows the negotiation
    of some options. Details about this message may be found in [**RFC 4271**](https://datatracker.ietf.org/doc/html/rfc4271.html).'
  prefs:
  - PREF_BQ
  - PREF_UL
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: 'NOTIFICATION : this message is used to terminate a BGP session, usually because
    an error has been detected by the BGP peer. A router that sends or receives a
    NOTIFICATION message immediately shutdowns the corresponding BGP session.'
  prefs:
  - PREF_BQ
  - PREF_UL
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: 'UPDATE: this message is used to advertise new or modified routes or to withdraw
    previously advertised routes.'
  prefs:
  - PREF_BQ
  - PREF_UL
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: 'KEEPALIVE : this message is used to ensure a regular exchange of messages on
    the BGP session, even when no route changes. When a BGP router has not sent an
    UPDATE message during the last 30 seconds, it shall send a KEEPALIVE message to
    confirm to the other peer that it is still up. If a peer does not receive any
    BGP message during a period of 90 seconds [[8]](#fdefaultkeepalive), the BGP session
    is considered to be down and all the routes learned over this session are withdrawn.'
  prefs:
  - PREF_BQ
  - PREF_UL
  type: TYPE_NORMAL
- en: 'As explained earlier, BGP relies on incremental updates. This implies that
    when a BGP session starts, each router first sends BGP UPDATE messages to advertise
    to the other peer all the exportable routes that it knows. Once all these routes
    have been advertised, the BGP router only sends BGP UPDATE messages about a prefix
    if the route is new, one of its attributes has changed or the route became unreachable
    and must be withdrawn. The BGP UPDATE message allows BGP routers to efficiently
    exchange such information while minimizing the number of bytes exchanged. Each
    UPDATE message contains :'
  prefs: []
  type: TYPE_NORMAL
- en: a list of IP prefixes that are withdrawn
  prefs:
  - PREF_BQ
  - PREF_UL
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: a list of IP prefixes that are (re-)advertised
  prefs:
  - PREF_BQ
  - PREF_UL
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: the set of attributes (e.g. AS-Path) associated to the advertised prefixes
  prefs:
  - PREF_BQ
  - PREF_UL
  type: TYPE_NORMAL
- en: 'In the remainder of this chapter, and although all routing information is exchanged
    using BGP UPDATE messages, we assume for simplicity that a BGP message contains
    only information about one prefix and we use the words :'
  prefs: []
  type: TYPE_NORMAL
- en: Withdraw message to indicate a BGP UPDATE message containing one route that
    is withdrawn
  prefs:
  - PREF_BQ
  - PREF_UL
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: Update message to indicate a BGP UPDATE containing a new or updated route towards
    one destination prefix with its attributes
  prefs:
  - PREF_BQ
  - PREF_UL
  type: TYPE_NORMAL
- en: From a conceptual point of view, a BGP router connected to N BGP peers, can
    be described as being composed of four parts as shown in the figure below.
  prefs: []
  type: TYPE_NORMAL
- en: '[![../_images/bgp-router.png](../Images/0079025668f84e1a91f1e4196c6e5332.png)](../_images/bgp-router.png)'
  prefs: []
  type: TYPE_NORMAL
- en: Fig. 158 Organization of a BGP router[#](#id36 "Link to this image")
  prefs: []
  type: TYPE_NORMAL
- en: 'In this figure, the router receives BGP messages on the left part of the figure,
    processes these messages and possibly sends BGP messages on the right part of
    the figure. A BGP router contains three important data structures :'
  prefs: []
  type: TYPE_NORMAL
- en: the Adj-RIB-In contains the BGP routes that have been received from each BGP
    peer. The routes in the Adj-RIB-In are filtered by the import filter before being
    placed in the BGP-Loc-RIB. There is one import filter per BGP peer.
  prefs:
  - PREF_BQ
  - PREF_UL
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: the Local Routing Information Base (Loc-RIB) contains all the routes that are
    considered as acceptable by the router. The Loc-RIB may contain several routes,
    learned from different BGP peers, towards the same destination prefix.
  prefs:
  - PREF_BQ
  - PREF_UL
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: the Forwarding Information Base (FIB) is used by the dataplane to forward packets
    towards their destination. The FIB contains, for each destination, the best route
    that has been selected by the BGP decision process. This decision process is an
    algorithm that selects, for each destination prefix, the best route according
    to the router’s ranking algorithm that is part of its policy.
  prefs:
  - PREF_BQ
  - PREF_UL
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: the Adj-RIB-Out contains the BGP routes that have been advertised to each BGP
    peer. The Adj-RIB-Out for a given peer is built by applying the peer’s export
    filter on the routes that have been installed in the FIB. There is one export
    filter per BGP peer. For this reason, the Adj-RIB-Out of a peer may contain different
    routes than the Adj-RIB-Out of another peer.
  prefs:
  - PREF_BQ
  - PREF_UL
  type: TYPE_NORMAL
- en: When a BGP session starts, the routers first exchange OPEN messages to negotiate
    the options that apply throughout the entire session. Then, each router extracts
    from its FIB the routes to be advertised to the peer. It is important to note
    that, for each known destination prefix, a BGP router can only advertise to a
    peer the route that it has itself installed inside its FIB. The routes that are
    advertised to a peer must pass the peer’s export filter. The export filter is
    a set of rules that define which routes can be advertised over the corresponding
    session, possibly after having modified some of its attributes. One export filter
    is associated to each BGP session. For example, on a shared-cost peering, the
    export filter only selects the internal routes and the routes that have been learned
    from a customer. The pseudo-code below shows the initialization of a BGP session.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE7]'
  prefs: []
  type: TYPE_PRE
- en: In the above pseudo-code, the build_BGP_update(d) procedure extracts from the
    BGP Loc-RIB the best path towards destination d (i.e. the route installed in the
    FIB) and prepares the corresponding BGP UPDATE message. This message is then passed
    to the export filter that returns None if the route cannot be advertised to the
    peer or the (possibly modified) BGP UPDATE message to be advertised. BGP routers
    allow network administrators to specify very complex export filters, see e.g.
    [[WMS2004]](../bibliography.html#wms2004). A simple export filter that implements
    the equivalent of split horizon is shown below.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE8]'
  prefs: []
  type: TYPE_PRE
- en: At this point, the remote router has received all the exportable BGP routes.
    After this initial exchange, the router only sends BGP UPDATE messages when there
    is a change (addition of a route, removal of a route or change in the attributes
    of a route) in one of these exportable routes. Such a change can happen when the
    router receives a BGP message. The pseudo-code below summarizes the processing
    of these BGP messages.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE9]'
  prefs: []
  type: TYPE_PRE
- en: When a BGP message is received, the router first applies the peer’s import filter
    to verify whether the message is acceptable or not. If the message is not acceptable,
    the processing stops. The pseudo-code below shows a simple import filter. This
    import filter accepts all routes, except those that already contain the local
    AS in their AS-Path. If such a route was used, it would cause a routing loop.
    Another example of an import filter would be a filter used by an Internet Service
    Provider on a session with a customer to only accept routes towards the IP prefixes
    assigned to the customer by the provider. On real routers, import filters can
    be much more complex and some import filters modify the attributes of the received
    BGP UPDATE [[WMS2004]](../bibliography.html#wms2004) .
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE10]'
  prefs: []
  type: TYPE_PRE
- en: Note
  prefs: []
  type: TYPE_NORMAL
- en: The bogon filters
  prefs: []
  type: TYPE_NORMAL
- en: Another example of frequently used import filters are the filters that Internet
    Service Providers use to ignore bogon routes. In the ISP community, a bogon route
    is a route that should not be advertised on the global Internet. Typical examples
    include the documentation IPv6 prefix (2001:db8::/32 used for most examples in
    this book), the loopback address (::1/128) or the IPv6 prefixes that have not
    yet been allocated by IANA. A well managed BGP router should ensure that it never
    advertises bogons on the global Internet. Detailed information about these bogons
    may be found in [[IMHM2013]](../bibliography.html#imhm2013).
  prefs: []
  type: TYPE_NORMAL
- en: If the import filter accepts the BGP message, the pseudo-code distinguishes
    two cases. If this is an Update message for prefix p, this can be a new route
    for this prefix or a modification of the route’s attributes. The router first
    retrieves from its RIB the best route towards prefix p. Then, the new route is
    inserted in the RIB and the BGP decision process is run to find whether the best
    route towards destination p changes. A BGP message only needs to be sent to the
    router’s peers if the best route has changed. For each peer, the router applies
    the export filter to verify whether the route can be advertised. If yes, the filtered
    BGP message is sent. Otherwise, a Withdraw message is sent. When the router receives
    a Withdraw message, it also verifies whether the removal of the route from its
    RIB caused its best route towards this prefix to change. It should be noted that,
    depending on the content of the RIB and the export filters, a BGP router may need
    to send a Withdraw message to a peer after having received an Update message from
    another peer and conversely.
  prefs: []
  type: TYPE_NORMAL
- en: Let us now discuss in more detail the operation of BGP in an IPv6 network. For
    this, let us consider the simple network composed of three routers located in
    three different ASes and shown in the figure below.
  prefs: []
  type: TYPE_NORMAL
- en: '[![../_images/bgp-nexthop.svg](../Images/e4d6965066e9e8670bd2ee7036f03d88.png)](../_images/bgp-nexthop.svg)'
  prefs: []
  type: TYPE_NORMAL
- en: Fig. 159 Utilization of the BGP nexthop attribute[#](#id37 "Link to this image")
  prefs: []
  type: TYPE_NORMAL
- en: 'This network contains three routers : R1, R2 and R3. Each router is attached
    to a local IPv6 subnet that it advertises using BGP. There are two BGP sessions,
    one between R1 and R2 and the second between R2 and R3. A /127 subnet is used
    on each interdomain link (2001:db8::4/127 on R1-R2 and 2001:db8::0/127 on R2-R3)
    in conformance with the latest recommendation [**RFC 6164**](https://datatracker.ietf.org/doc/html/rfc6164.html).
    The BGP sessions run above TCP connections established between the neighboring
    routers (e.g. 2001:db8::5 - 2001:db8::6 for the R1-R2 session).'
  prefs: []
  type: TYPE_NORMAL
- en: 'Let us assume that the R1-R2 BGP session is the first to be established. A
    BGP Update message sent on such a session contains three fields :'
  prefs: []
  type: TYPE_NORMAL
- en: the advertised prefix
  prefs:
  - PREF_BQ
  - PREF_UL
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: the BGP nexthop
  prefs:
  - PREF_BQ
  - PREF_UL
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: the attributes including the AS-Path
  prefs:
  - PREF_BQ
  - PREF_UL
  type: TYPE_NORMAL
- en: We use the notation U(prefix, nexthop, attributes) to represent such a BGP Update
    message in this section. Similarly, W(prefix) represents a BGP withdraw for the
    specified prefix. Once the R1-R2 session has been established, R1 sends U(2001:db8:1234::/48,2001:db8::5,AS10)
    to R2 and R2 sends U(2001:db8:5678:/48,2001:db8::6,AS20). At this point, R1 can
    reach 2001:db8:5678::/48 via 2001:db8::6 and R2 can reach 2001:db8:1234::/48 via
    2001:db8::5.
  prefs: []
  type: TYPE_NORMAL
- en: 'Once the R2-R3 has been established, R3 sends U(2001:db8:acbd::/48,2001:db8::2,AS30).
    R2 announces on the R2-R3 session all the routes inside its RIB. It thus sends
    to R3 : U(2001:db8:1234::/48,2001:db8::1,AS20:AS10) and U(2001:db8:5678::/48,2001:db8::1,AS20).
    Note that when R2 advertises the route that it learned from R1, it updates the
    BGP nexthop and adds its AS number to the AS-Path. R2 also sends U(2001:db8:abcd::48,2001:db8::6,AS20:AS30)
    to R1 on the R1-R3 session. At this point, all BGP routes have been exchanged
    and all routers can reach 2001:db8::1234/48, 2001:db8:5678::/48 and 2001:db8:abcd::/48.'
  prefs: []
  type: TYPE_NORMAL
- en: If the link between R2 and R3 fails, R3 detects the failure as it did not receive
    KEEPALIVE messages recently from R2. At this time, R3 removes from its RIB all
    the routes learned over the R2-R3 BGP session. R2 also removes from its RIB the
    routes learned from R3. R2 also sends W(2001:db8:acbd::/48) to R1 over the R1-R3
    BGP session since it does not have a route anymore towards this prefix.
  prefs: []
  type: TYPE_NORMAL
- en: Note
  prefs: []
  type: TYPE_NORMAL
- en: Origin of the routes advertised by a BGP router
  prefs: []
  type: TYPE_NORMAL
- en: 'A frequent practical question about the operation of BGP is how a BGP router
    decides to originate or advertise a route for the first time. In practice, this
    occurs in two situations :'
  prefs: []
  type: TYPE_NORMAL
- en: the router has been manually configured by the network operator to always advertise
    one or several routes on a BGP session. For example, on the BGP session between
    UCLouvain and its provider, [belnet](https://www.belnet.be) , UCLouvain’s router
    always advertises the 2001:6a8:3080/48 IPv6 prefix assigned to the campus network
  prefs:
  - PREF_BQ
  - PREF_UL
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: the router has been configured by the network operator to advertise over its
    BGP session some of the routes that it learns with its intradomain routing protocol.
    For example, an enterprise router may advertise over a BGP session with its provider
    the routes to remote sites when these routes are reachable and advertised by the
    intradomain routing protocol
  prefs:
  - PREF_BQ
  - PREF_UL
  type: TYPE_NORMAL
- en: The first solution is the most frequent. Advertising routes learned from an
    intradomain routing protocol is not recommended, this is because if the route
    flaps [[9]](#fflap), this would cause a large number of BGP messages being exchanged
    in the global Internet.
  prefs: []
  type: TYPE_NORMAL
- en: '### The BGP decision process[#](#the-bgp-decision-process "Link to this heading")'
  prefs: []
  type: TYPE_NORMAL
- en: Besides the import and export filters, a key difference between BGP and the
    intradomain routing protocols is that each domain can define its own ranking algorithm
    to determine which route is chosen to forward packets when several routes have
    been learned towards the same prefix. This ranking depends on several BGP attributes
    that can be attached to a BGP route.
  prefs: []
  type: TYPE_NORMAL
- en: The first BGP attribute that is used to rank BGP routes is the local-preference
    (local-pref) attribute. This attribute is an unsigned integer that is attached
    to each BGP route received over an eBGP session by the associated import filter.
  prefs: []
  type: TYPE_NORMAL
- en: When comparing routes towards the same destination prefix, a BGP router always
    prefers the routes with the highest local-pref. If the BGP router knows several
    routes with the same local-pref, it prefers among the routes having this local-pref
    the ones with the shortest AS-Path.
  prefs: []
  type: TYPE_NORMAL
- en: The local-pref attribute is often used to prefer some routes over others.
  prefs: []
  type: TYPE_NORMAL
- en: A common utilization of local-pref is to support backup links. Consider the
    situation depicted in the figure below. AS1 would always like to use the high
    bandwidth link to send and receive packets via AS2 and only use the backup link
    upon failure of the primary one.
  prefs: []
  type: TYPE_NORMAL
- en: '[![../_images/bgp-backup.svg](../Images/a3485a4ec7385b94aecb7b585e809d0b.png)](../_images/bgp-backup.svg)'
  prefs: []
  type: TYPE_NORMAL
- en: Fig. 160 How to create a backup link with BGP ?[#](#id38 "Link to this image")
  prefs: []
  type: TYPE_NORMAL
- en: As BGP routers always prefer the routes with the highest local-pref attribute,
    this policy can be implemented using the following import filter on R1
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE11]'
  prefs: []
  type: TYPE_PRE
- en: With this import filter, all the BGP routes learned from RB over the high bandwidth
    links are preferred over the routes learned over the backup link. If the primary
    link fails, the corresponding routes are removed from R1’s RIB and R1 uses the
    route learned from RA. R1 reuses the routes via RB as soon as they are advertised
    by RB once the R1-RB link comes back.
  prefs: []
  type: TYPE_NORMAL
- en: The import filter above modifies the selection of the BGP routes inside AS1.
    Thus, it influences the route followed by the packets forwarded by AS1. In addition
    to using the primary link to send packets, AS1 would like to receive its packets
    via the high bandwidth link. For this, AS2 also needs to set the local-pref attribute
    in its import filter.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE12]'
  prefs: []
  type: TYPE_PRE
- en: Sometimes, the local-pref attribute is used to prefer a cheap link compared
    to a more expensive one. For example, in the network below, AS1 could wish to
    send and receive packets mainly via its interdomain link with AS4.
  prefs: []
  type: TYPE_NORMAL
- en: '[![../_images/bgp-prefer.svg](../Images/a6ae4372991a589dfd16713f3fbf28dc.png)](../_images/bgp-prefer.svg)'
  prefs: []
  type: TYPE_NORMAL
- en: Fig. 161 How to prefer a cheap link over an more expensive one ?[#](#id39 "Link
    to this image")
  prefs: []
  type: TYPE_NORMAL
- en: AS1 can install the following import filter on R1 to ensure that it always sends
    packets via R2 when it has learned a route via AS2 and another via AS4.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE13]'
  prefs: []
  type: TYPE_PRE
- en: However, this import filter does not influence how AS3 , for example, prefers
    some routes over others. If the link between AS3 and AS2 is less expensive than
    the link between AS3 and AS4, AS3 could send all its packets via AS2 and AS1 would
    receive packets over its expensive link. An important point to remember about
    local-pref is that it can be used to prefer some routes over others to send packets,
    but it has no influence on the routes followed by received packets.
  prefs: []
  type: TYPE_NORMAL
- en: 'Another important utilization of the local-pref attribute is to support the
    customer->provider and shared-cost peering relationships. From an economic point
    of view, there is an important difference between these three types of peering
    relationships. A domain usually earns money when it sends packets over a provider->customer
    relationship. On the other hand, it must pay its provider when it sends packets
    over a customer->provider relationship. Using a shared-cost peering to send packets
    is usually neutral from an economic perspective. To take into account these economic
    issues, domains usually configure the import filters on their routers as follows
    :'
  prefs: []
  type: TYPE_NORMAL
- en: insert a high local-pref attribute in the routes learned from a customer
  prefs:
  - PREF_BQ
  - PREF_UL
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: insert a medium local-pref attribute in the routes learned over a shared-cost
    peering
  prefs:
  - PREF_BQ
  - PREF_UL
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: insert a low local-pref attribute in the routes learned from a provider
  prefs:
  - PREF_BQ
  - PREF_UL
  type: TYPE_NORMAL
- en: With such an import filter, the routers of a domain always prefer to reach destinations
    via their customers whenever such a route exists. Otherwise, they prefer to use
    shared-cost peering relationships and they only send packets via their providers
    when they do not know any alternate route. A consequence of setting the local-pref
    attribute like this is that Internet paths are often asymmetrical. Consider for
    example the internetwork shown in the figure below.
  prefs: []
  type: TYPE_NORMAL
- en: '[![../_images/asymetry.svg](../Images/0a126e385db1ba6a60851408e8964db3.png)](../_images/asymetry.svg)'
  prefs: []
  type: TYPE_NORMAL
- en: Fig. 162 Asymmetry of Internet paths[#](#id40 "Link to this image")
  prefs: []
  type: TYPE_NORMAL
- en: Consider in this internetwork the routes available inside AS1 to reach AS5.
    AS1 learns the AS4:AS6:AS7:AS5 path from AS4, the AS3:AS8:AS5 path from AS3 and
    the AS2:AS5 path from AS2. The first path is chosen since it was learned from
    a customer. AS5 on the other hand receives three paths towards AS1 via its providers.
    It may select any of these paths to reach AS1 , depending on how it prefers one
    provider over the others.
  prefs: []
  type: TYPE_NORMAL
- en: BGP convergence[#](#bgp-convergence "Link to this heading")
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: In the previous sections, we have explained the operation of BGP routers. Compared
    to intradomain routing protocols, a key feature of BGP is its ability to support
    interdomain routing policies that are defined by each domain as its import and
    export filters and ranking process. A domain can define its own routing policies
    and router vendors have implemented many configuration tweaks to support complex
    routing policies. However, the routing policy chosen by a domain may interfere
    with the routing policy chosen by another domain. To understand this issue, let
    us first consider the simple internetwork shown below.
  prefs: []
  type: TYPE_NORMAL
- en: '[![../_images/disagree.svg](../Images/e0d8fea96abc42f780dccaaf6f640d03.png)](../_images/disagree.svg)'
  prefs: []
  type: TYPE_NORMAL
- en: Fig. 163 The disagree internetwork[#](#id41 "Link to this image")
  prefs: []
  type: TYPE_NORMAL
- en: 'In this internetwork, we focus on the route towards 2001:db8::1234/48 which
    is advertised by AS1. Let us also assume that AS3 (resp. AS4) prefers, e.g. for
    economic reasons, a route learned from AS4 (AS3) over a route learned from AS1.
    When AS1 sends U(2001:db8::1234/48,AS1) to AS3 and AS4, three sequences of exchanges
    of BGP messages are possible :'
  prefs: []
  type: TYPE_NORMAL
- en: AS3 sends first U(2001:db8:1234/48,AS3:AS1) to AS4. AS4 has learned two routes
    towards 2001:db8:1234/48. It runs its BGP decision process and selects the route
    via AS3 and does not advertise a route to AS3
  prefs:
  - PREF_BQ
  - PREF_OL
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: AS4 first sends U(2001:db8:1234/48,AS4:AS1) to AS3. AS3 has learned two routes
    towards 2001:db8:1234/48. It runs its BGP decision process and selects the route
    via AS4 and does not advertise a route to AS4
  prefs:
  - PREF_BQ
  - PREF_OL
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: AS3 sends U(2001:db8:1234/48,AS3:AS1) to AS4 and, at the same time, AS4 sends
    U(2001:db8:1234/48,AS4:AS1). AS3 prefers the route via AS4 and thus sends W(2001:db8:1234/48)
    to AS4. In the mean time, AS4 prefers the route via AS3 and thus sends W(2001:db8:1234/48)
    to AS3. Upon reception of the BGP Withdraws, AS3 and AS4 only know the direct
    route towards 2001:db8:1234/48. AS3 (resp. AS4) sends U(2001:db8:1234/48,AS3:AS1)
    (resp. U(2001:db8:1234/48,AS4:AS1)) to AS4 (resp. AS3). AS3 and AS4 could in theory
    continue to exchange BGP messages for ever. In practice, one of them sends one
    message faster than the other and BGP converges.
  prefs:
  - PREF_BQ
  - PREF_OL
  type: TYPE_NORMAL
- en: The example above has shown that the routes selected by BGP routers may sometimes
    depend on the ordering of the BGP messages that are exchanged. Other similar scenarios
    may be found in [**RFC 4264**](https://datatracker.ietf.org/doc/html/rfc4264.html).
  prefs: []
  type: TYPE_NORMAL
- en: From an operational perspective, the above configuration is annoying since the
    network operators cannot easily predict which paths are chosen. Unfortunately,
    there are even more annoying BGP configurations. For example, let us consider
    the configuration below which is often named Bad Gadget [[GW1999]](../bibliography.html#gw1999)
  prefs: []
  type: TYPE_NORMAL
- en: '[![../_images/bad-gadget.svg](../Images/98a26037d12a6cb60b64faf1e25a4470.png)](../_images/bad-gadget.svg)'
  prefs: []
  type: TYPE_NORMAL
- en: Fig. 164 The bad gadget internetwork[#](#id42 "Link to this image")
  prefs: []
  type: TYPE_NORMAL
- en: 'In this internetwork, there are four ASes. AS0 advertises one route towards
    one prefix and we only analyze the routes towards this prefix. The routing preferences
    of AS1, AS3 and AS4 are the following :'
  prefs: []
  type: TYPE_NORMAL
- en: AS1 prefers the path AS3:AS0 over all other paths
  prefs:
  - PREF_BQ
  - PREF_UL
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: AS3 prefers the path AS4:AS0 over all other paths
  prefs:
  - PREF_BQ
  - PREF_UL
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: AS4 prefers the path AS1:AS0 over all other paths
  prefs:
  - PREF_BQ
  - PREF_UL
  type: TYPE_NORMAL
- en: 'AS0 sends U(p,AS0) to AS1, AS3 and AS4. As this is the only route known by
    AS1, AS3 and AS4 towards p, they all select the direct path. Let us now consider
    one possible exchange of BGP messages :'
  prefs: []
  type: TYPE_NORMAL
- en: AS1 sends U(p, AS1:AS0) to AS3 and AS4. AS4 selects the path via AS1 since this
    is its preferred path. AS3 still uses the direct path.
  prefs:
  - PREF_BQ
  - PREF_OL
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: AS4 advertises U(p,AS4:AS1:AS0) to AS3.
  prefs:
  - PREF_BQ
  - PREF_OL
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: AS3 sends U(p, AS3:AS0) to AS1 and AS4. AS1 selects the path via AS3 since this
    is its preferred path. AS4 still uses the path via AS1.
  prefs:
  - PREF_BQ
  - PREF_OL
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: As AS1 has changed its path, it sends U(p,AS1:AS3:AS0) to AS4 and W(p) to AS3
    since its new path is via AS3. AS4 switches back to the direct path.
  prefs:
  - PREF_BQ
  - PREF_OL
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: AS4 sends U(p,AS4:AS0) to AS1 and AS3. AS3 prefers the path via AS4.
  prefs:
  - PREF_BQ
  - PREF_OL
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: AS3 sends U(p,AS3:AS4:AS0) to AS1 and W(p) to AS4. AS1 switches back to the
    direct path and we are back at the first step.
  prefs:
  - PREF_BQ
  - PREF_OL
  type: TYPE_NORMAL
- en: This example shows that the convergence of BGP is unfortunately not always guaranteed
    as some interdomain routing policies may interfere with each other in complex
    ways. [[GW1999]](../bibliography.html#gw1999) have shown that checking for global
    convergence is either NP-complete or NP-hard. See [[GSW2002]](../bibliography.html#gsw2002)
    for a more detailed discussion.
  prefs: []
  type: TYPE_NORMAL
- en: 'Fortunately, there are some operational guidelines [[GR2001]](../bibliography.html#gr2001)
    [[GGR2001]](../bibliography.html#ggr2001) that can guarantee BGP convergence in
    the global Internet. To ensure that BGP will converge, these guidelines consider
    that there are two types of peering relationships : customer->provider and shared-cost.
    In this case, BGP convergence is guaranteed provided that the following conditions
    are fulfilled :'
  prefs: []
  type: TYPE_NORMAL
- en: The topology composed of all the directed customer->provider peering links is
    a graph that does not contain any cycle
  prefs:
  - PREF_BQ
  - PREF_OL
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: An AS always prefers a route received from a customer over a route received
    from a shared-cost peer or a provider.
  prefs:
  - PREF_BQ
  - PREF_OL
  type: TYPE_NORMAL
- en: The first guideline implies that the provider of the provider of ASx cannot
    be a customer of ASx. Such a relationship would not make sense from an economic
    perspective as it would imply circular payments. Furthermore, providers are usually
    larger than customers.
  prefs: []
  type: TYPE_NORMAL
- en: The second guideline also corresponds to economic preferences. Since a provider
    earns money when sending packets to one of its customers, it makes sense to prefer
    such customer learned routes over routes learned from providers. [[GR2001]](../bibliography.html#gr2001)
    also shows that BGP convergence is guaranteed even if an AS associates the same
    preference to routes learned from a shared-cost peer and routes learned from a
    customer.
  prefs: []
  type: TYPE_NORMAL
- en: From a theoretical perspective, these guidelines should be verified automatically
    to ensure that BGP will always converge in the global Internet. However, such
    a verification cannot be performed in practice because this would force all domains
    to disclose their routing policies (and few are willing to do so) and furthermore
    the problem is known to be NP-hard [GW1999].
  prefs: []
  type: TYPE_NORMAL
- en: In practice, researchers and operators expect that these guidelines are verified
    [[10]](#fgranularity) in most domains. Thanks to the large amount of BGP data
    that has been collected by operators and researchers [[11]](#fbgpdata), several
    studies have analyzed the AS-level topology of the Internet. [[SARK2002]](../bibliography.html#sark2002)
    is one of the first analysis. More recent studies include [[COZ2008]](../bibliography.html#coz2008)
    and [[DKF+2007]](../bibliography.html#dkf-2007)
  prefs: []
  type: TYPE_NORMAL
- en: Based on these studies and [[ATLAS2009]](../bibliography.html#atlas2009), the
    AS-level Internet topology can be summarized as shown in the figure below.
  prefs: []
  type: TYPE_NORMAL
- en: '[![../_images/bgp-hierarchy.svg](../Images/7ed75e3a3085ea745ef374995877c629.png)](../_images/bgp-hierarchy.svg)'
  prefs: []
  type: TYPE_NORMAL
- en: Fig. 165 The layered structure of the global Internet[#](#id43 "Link to this
    image")
  prefs: []
  type: TYPE_NORMAL
- en: The domains on the Internet can be divided in about four categories according
    to their role and their position in the AS-level topology.
  prefs: []
  type: TYPE_NORMAL
- en: Due to this organization of the Internet and due to the BGP decision process,
    most AS-level paths on the Internet have a length of 3-5 AS hops.
  prefs: []
  type: TYPE_NORMAL
- en: Footnotes
  prefs: []
  type: TYPE_NORMAL
- en: '### The BGP decision process[#](#the-bgp-decision-process "Link to this heading")'
  prefs: []
  type: TYPE_NORMAL
- en: Besides the import and export filters, a key difference between BGP and the
    intradomain routing protocols is that each domain can define its own ranking algorithm
    to determine which route is chosen to forward packets when several routes have
    been learned towards the same prefix. This ranking depends on several BGP attributes
    that can be attached to a BGP route.
  prefs: []
  type: TYPE_NORMAL
- en: The first BGP attribute that is used to rank BGP routes is the local-preference
    (local-pref) attribute. This attribute is an unsigned integer that is attached
    to each BGP route received over an eBGP session by the associated import filter.
  prefs: []
  type: TYPE_NORMAL
- en: When comparing routes towards the same destination prefix, a BGP router always
    prefers the routes with the highest local-pref. If the BGP router knows several
    routes with the same local-pref, it prefers among the routes having this local-pref
    the ones with the shortest AS-Path.
  prefs: []
  type: TYPE_NORMAL
- en: The local-pref attribute is often used to prefer some routes over others.
  prefs: []
  type: TYPE_NORMAL
- en: A common utilization of local-pref is to support backup links. Consider the
    situation depicted in the figure below. AS1 would always like to use the high
    bandwidth link to send and receive packets via AS2 and only use the backup link
    upon failure of the primary one.
  prefs: []
  type: TYPE_NORMAL
- en: '[![../_images/bgp-backup.svg](../Images/a3485a4ec7385b94aecb7b585e809d0b.png)](../_images/bgp-backup.svg)'
  prefs: []
  type: TYPE_NORMAL
- en: Fig. 160 How to create a backup link with BGP ?[#](#id38 "Link to this image")
  prefs: []
  type: TYPE_NORMAL
- en: As BGP routers always prefer the routes with the highest local-pref attribute,
    this policy can be implemented using the following import filter on R1
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE14]'
  prefs: []
  type: TYPE_PRE
- en: With this import filter, all the BGP routes learned from RB over the high bandwidth
    links are preferred over the routes learned over the backup link. If the primary
    link fails, the corresponding routes are removed from R1’s RIB and R1 uses the
    route learned from RA. R1 reuses the routes via RB as soon as they are advertised
    by RB once the R1-RB link comes back.
  prefs: []
  type: TYPE_NORMAL
- en: The import filter above modifies the selection of the BGP routes inside AS1.
    Thus, it influences the route followed by the packets forwarded by AS1. In addition
    to using the primary link to send packets, AS1 would like to receive its packets
    via the high bandwidth link. For this, AS2 also needs to set the local-pref attribute
    in its import filter.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE15]'
  prefs: []
  type: TYPE_PRE
- en: Sometimes, the local-pref attribute is used to prefer a cheap link compared
    to a more expensive one. For example, in the network below, AS1 could wish to
    send and receive packets mainly via its interdomain link with AS4.
  prefs: []
  type: TYPE_NORMAL
- en: '[![../_images/bgp-prefer.svg](../Images/a6ae4372991a589dfd16713f3fbf28dc.png)](../_images/bgp-prefer.svg)'
  prefs: []
  type: TYPE_NORMAL
- en: Fig. 161 How to prefer a cheap link over an more expensive one ?[#](#id39 "Link
    to this image")
  prefs: []
  type: TYPE_NORMAL
- en: AS1 can install the following import filter on R1 to ensure that it always sends
    packets via R2 when it has learned a route via AS2 and another via AS4.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE16]'
  prefs: []
  type: TYPE_PRE
- en: However, this import filter does not influence how AS3 , for example, prefers
    some routes over others. If the link between AS3 and AS2 is less expensive than
    the link between AS3 and AS4, AS3 could send all its packets via AS2 and AS1 would
    receive packets over its expensive link. An important point to remember about
    local-pref is that it can be used to prefer some routes over others to send packets,
    but it has no influence on the routes followed by received packets.
  prefs: []
  type: TYPE_NORMAL
- en: 'Another important utilization of the local-pref attribute is to support the
    customer->provider and shared-cost peering relationships. From an economic point
    of view, there is an important difference between these three types of peering
    relationships. A domain usually earns money when it sends packets over a provider->customer
    relationship. On the other hand, it must pay its provider when it sends packets
    over a customer->provider relationship. Using a shared-cost peering to send packets
    is usually neutral from an economic perspective. To take into account these economic
    issues, domains usually configure the import filters on their routers as follows
    :'
  prefs: []
  type: TYPE_NORMAL
- en: insert a high local-pref attribute in the routes learned from a customer
  prefs:
  - PREF_BQ
  - PREF_UL
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: insert a medium local-pref attribute in the routes learned over a shared-cost
    peering
  prefs:
  - PREF_BQ
  - PREF_UL
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: insert a low local-pref attribute in the routes learned from a provider
  prefs:
  - PREF_BQ
  - PREF_UL
  type: TYPE_NORMAL
- en: With such an import filter, the routers of a domain always prefer to reach destinations
    via their customers whenever such a route exists. Otherwise, they prefer to use
    shared-cost peering relationships and they only send packets via their providers
    when they do not know any alternate route. A consequence of setting the local-pref
    attribute like this is that Internet paths are often asymmetrical. Consider for
    example the internetwork shown in the figure below.
  prefs: []
  type: TYPE_NORMAL
- en: '[![../_images/asymetry.svg](../Images/0a126e385db1ba6a60851408e8964db3.png)](../_images/asymetry.svg)'
  prefs: []
  type: TYPE_NORMAL
- en: Fig. 162 Asymmetry of Internet paths[#](#id40 "Link to this image")
  prefs: []
  type: TYPE_NORMAL
- en: Consider in this internetwork the routes available inside AS1 to reach AS5.
    AS1 learns the AS4:AS6:AS7:AS5 path from AS4, the AS3:AS8:AS5 path from AS3 and
    the AS2:AS5 path from AS2. The first path is chosen since it was learned from
    a customer. AS5 on the other hand receives three paths towards AS1 via its providers.
    It may select any of these paths to reach AS1 , depending on how it prefers one
    provider over the others.
  prefs: []
  type: TYPE_NORMAL
- en: BGP convergence[#](#bgp-convergence "Link to this heading")
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: In the previous sections, we have explained the operation of BGP routers. Compared
    to intradomain routing protocols, a key feature of BGP is its ability to support
    interdomain routing policies that are defined by each domain as its import and
    export filters and ranking process. A domain can define its own routing policies
    and router vendors have implemented many configuration tweaks to support complex
    routing policies. However, the routing policy chosen by a domain may interfere
    with the routing policy chosen by another domain. To understand this issue, let
    us first consider the simple internetwork shown below.
  prefs: []
  type: TYPE_NORMAL
- en: '[![../_images/disagree.svg](../Images/e0d8fea96abc42f780dccaaf6f640d03.png)](../_images/disagree.svg)'
  prefs: []
  type: TYPE_NORMAL
- en: Fig. 163 The disagree internetwork[#](#id41 "Link to this image")
  prefs: []
  type: TYPE_NORMAL
- en: 'In this internetwork, we focus on the route towards 2001:db8::1234/48 which
    is advertised by AS1. Let us also assume that AS3 (resp. AS4) prefers, e.g. for
    economic reasons, a route learned from AS4 (AS3) over a route learned from AS1.
    When AS1 sends U(2001:db8::1234/48,AS1) to AS3 and AS4, three sequences of exchanges
    of BGP messages are possible :'
  prefs: []
  type: TYPE_NORMAL
- en: AS3 sends first U(2001:db8:1234/48,AS3:AS1) to AS4. AS4 has learned two routes
    towards 2001:db8:1234/48. It runs its BGP decision process and selects the route
    via AS3 and does not advertise a route to AS3
  prefs:
  - PREF_BQ
  - PREF_OL
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: AS4 first sends U(2001:db8:1234/48,AS4:AS1) to AS3. AS3 has learned two routes
    towards 2001:db8:1234/48. It runs its BGP decision process and selects the route
    via AS4 and does not advertise a route to AS4
  prefs:
  - PREF_BQ
  - PREF_OL
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: AS3 sends U(2001:db8:1234/48,AS3:AS1) to AS4 and, at the same time, AS4 sends
    U(2001:db8:1234/48,AS4:AS1). AS3 prefers the route via AS4 and thus sends W(2001:db8:1234/48)
    to AS4. In the mean time, AS4 prefers the route via AS3 and thus sends W(2001:db8:1234/48)
    to AS3. Upon reception of the BGP Withdraws, AS3 and AS4 only know the direct
    route towards 2001:db8:1234/48. AS3 (resp. AS4) sends U(2001:db8:1234/48,AS3:AS1)
    (resp. U(2001:db8:1234/48,AS4:AS1)) to AS4 (resp. AS3). AS3 and AS4 could in theory
    continue to exchange BGP messages for ever. In practice, one of them sends one
    message faster than the other and BGP converges.
  prefs:
  - PREF_BQ
  - PREF_OL
  type: TYPE_NORMAL
- en: The example above has shown that the routes selected by BGP routers may sometimes
    depend on the ordering of the BGP messages that are exchanged. Other similar scenarios
    may be found in [**RFC 4264**](https://datatracker.ietf.org/doc/html/rfc4264.html).
  prefs: []
  type: TYPE_NORMAL
- en: From an operational perspective, the above configuration is annoying since the
    network operators cannot easily predict which paths are chosen. Unfortunately,
    there are even more annoying BGP configurations. For example, let us consider
    the configuration below which is often named Bad Gadget [[GW1999]](../bibliography.html#gw1999)
  prefs: []
  type: TYPE_NORMAL
- en: '[![../_images/bad-gadget.svg](../Images/98a26037d12a6cb60b64faf1e25a4470.png)](../_images/bad-gadget.svg)'
  prefs: []
  type: TYPE_NORMAL
- en: Fig. 164 The bad gadget internetwork[#](#id42 "Link to this image")
  prefs: []
  type: TYPE_NORMAL
- en: 'In this internetwork, there are four ASes. AS0 advertises one route towards
    one prefix and we only analyze the routes towards this prefix. The routing preferences
    of AS1, AS3 and AS4 are the following :'
  prefs: []
  type: TYPE_NORMAL
- en: AS1 prefers the path AS3:AS0 over all other paths
  prefs:
  - PREF_BQ
  - PREF_UL
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: AS3 prefers the path AS4:AS0 over all other paths
  prefs:
  - PREF_BQ
  - PREF_UL
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: AS4 prefers the path AS1:AS0 over all other paths
  prefs:
  - PREF_BQ
  - PREF_UL
  type: TYPE_NORMAL
- en: 'AS0 sends U(p,AS0) to AS1, AS3 and AS4. As this is the only route known by
    AS1, AS3 and AS4 towards p, they all select the direct path. Let us now consider
    one possible exchange of BGP messages :'
  prefs: []
  type: TYPE_NORMAL
- en: AS1 sends U(p, AS1:AS0) to AS3 and AS4. AS4 selects the path via AS1 since this
    is its preferred path. AS3 still uses the direct path.
  prefs:
  - PREF_BQ
  - PREF_OL
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: AS4 advertises U(p,AS4:AS1:AS0) to AS3.
  prefs:
  - PREF_BQ
  - PREF_OL
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: AS3 sends U(p, AS3:AS0) to AS1 and AS4. AS1 selects the path via AS3 since this
    is its preferred path. AS4 still uses the path via AS1.
  prefs:
  - PREF_BQ
  - PREF_OL
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: As AS1 has changed its path, it sends U(p,AS1:AS3:AS0) to AS4 and W(p) to AS3
    since its new path is via AS3. AS4 switches back to the direct path.
  prefs:
  - PREF_BQ
  - PREF_OL
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: AS4 sends U(p,AS4:AS0) to AS1 and AS3. AS3 prefers the path via AS4.
  prefs:
  - PREF_BQ
  - PREF_OL
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: AS3 sends U(p,AS3:AS4:AS0) to AS1 and W(p) to AS4. AS1 switches back to the
    direct path and we are back at the first step.
  prefs:
  - PREF_BQ
  - PREF_OL
  type: TYPE_NORMAL
- en: This example shows that the convergence of BGP is unfortunately not always guaranteed
    as some interdomain routing policies may interfere with each other in complex
    ways. [[GW1999]](../bibliography.html#gw1999) have shown that checking for global
    convergence is either NP-complete or NP-hard. See [[GSW2002]](../bibliography.html#gsw2002)
    for a more detailed discussion.
  prefs: []
  type: TYPE_NORMAL
- en: 'Fortunately, there are some operational guidelines [[GR2001]](../bibliography.html#gr2001)
    [[GGR2001]](../bibliography.html#ggr2001) that can guarantee BGP convergence in
    the global Internet. To ensure that BGP will converge, these guidelines consider
    that there are two types of peering relationships : customer->provider and shared-cost.
    In this case, BGP convergence is guaranteed provided that the following conditions
    are fulfilled :'
  prefs: []
  type: TYPE_NORMAL
- en: The topology composed of all the directed customer->provider peering links is
    a graph that does not contain any cycle
  prefs:
  - PREF_BQ
  - PREF_OL
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  - PREF_IND
  type: TYPE_NORMAL
- en: An AS always prefers a route received from a customer over a route received
    from a shared-cost peer or a provider.
  prefs:
  - PREF_BQ
  - PREF_OL
  type: TYPE_NORMAL
- en: The first guideline implies that the provider of the provider of ASx cannot
    be a customer of ASx. Such a relationship would not make sense from an economic
    perspective as it would imply circular payments. Furthermore, providers are usually
    larger than customers.
  prefs: []
  type: TYPE_NORMAL
- en: The second guideline also corresponds to economic preferences. Since a provider
    earns money when sending packets to one of its customers, it makes sense to prefer
    such customer learned routes over routes learned from providers. [[GR2001]](../bibliography.html#gr2001)
    also shows that BGP convergence is guaranteed even if an AS associates the same
    preference to routes learned from a shared-cost peer and routes learned from a
    customer.
  prefs: []
  type: TYPE_NORMAL
- en: From a theoretical perspective, these guidelines should be verified automatically
    to ensure that BGP will always converge in the global Internet. However, such
    a verification cannot be performed in practice because this would force all domains
    to disclose their routing policies (and few are willing to do so) and furthermore
    the problem is known to be NP-hard [GW1999].
  prefs: []
  type: TYPE_NORMAL
- en: In practice, researchers and operators expect that these guidelines are verified
    [[10]](#fgranularity) in most domains. Thanks to the large amount of BGP data
    that has been collected by operators and researchers [[11]](#fbgpdata), several
    studies have analyzed the AS-level topology of the Internet. [[SARK2002]](../bibliography.html#sark2002)
    is one of the first analysis. More recent studies include [[COZ2008]](../bibliography.html#coz2008)
    and [[DKF+2007]](../bibliography.html#dkf-2007)
  prefs: []
  type: TYPE_NORMAL
- en: Based on these studies and [[ATLAS2009]](../bibliography.html#atlas2009), the
    AS-level Internet topology can be summarized as shown in the figure below.
  prefs: []
  type: TYPE_NORMAL
- en: '[![../_images/bgp-hierarchy.svg](../Images/7ed75e3a3085ea745ef374995877c629.png)](../_images/bgp-hierarchy.svg)'
  prefs: []
  type: TYPE_NORMAL
- en: Fig. 165 The layered structure of the global Internet[#](#id43 "Link to this
    image")
  prefs: []
  type: TYPE_NORMAL
- en: The domains on the Internet can be divided in about four categories according
    to their role and their position in the AS-level topology.
  prefs: []
  type: TYPE_NORMAL
- en: Due to this organization of the Internet and due to the BGP decision process,
    most AS-level paths on the Internet have a length of 3-5 AS hops.
  prefs: []
  type: TYPE_NORMAL
- en: Footnotes
  prefs: []
  type: TYPE_NORMAL
