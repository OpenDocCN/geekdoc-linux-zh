- en: Opensocket and closesocket
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Occasionally you end up in a situation where you want your application to control
    with more precision exactly what socket libcurl uses for its operations. libcurl
    offers this pair of callbacks that replaces libcurl’s own call to `socket()` and
    the subsequent `close()` of the same file descriptor.
  prefs: []
  type: TYPE_NORMAL
- en: Provide a file descriptor
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'By setting the `CURLOPT_OPENSOCKETFUNCTION` callback, you can provide a custom
    function to return a file descriptor for libcurl to use:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  prefs: []
  type: TYPE_PRE
- en: 'The `opensocket_callback` function must match this prototype:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE1]'
  prefs: []
  type: TYPE_PRE
- en: The callback gets the *clientp* as first argument, which is simply an opaque
    pointer you set with `CURLOPT_OPENSOCKETDATA`.
  prefs: []
  type: TYPE_NORMAL
- en: The other two arguments pass in data that identifies for what *purpose* and
    *address* the socket is to be used. The *purpose* is a typedef with a value of
    `CURLSOCKTYPE_IPCXN` or `CURLSOCKTYPE_ACCEPT`, identifying in which circumstance
    the socket is created. The “accept” case being when libcurl is used to accept
    an incoming FTP connection for when FTP active mode is used, and all other cases
    when libcurl creates a socket for its own outgoing connections the *IPCXN* value
    is passed in.
  prefs: []
  type: TYPE_NORMAL
- en: The *address* pointer points to a `struct curl_sockaddr` that describes the
    IP address of the network destination for which this socket is created. Your callback
    can for example use this information to whitelist or blacklist specific addresses
    or address ranges.
  prefs: []
  type: TYPE_NORMAL
- en: The socketopen callback is also explicitly allowed to modify the target address
    in that struct, if you would like to offer some sort of network filter or translation
    layer.
  prefs: []
  type: TYPE_NORMAL
- en: The callback should return a file descriptor or `CURL_SOCKET_BAD`, which then
    causes an unrecoverable error within libcurl and it returns `CURLE_COULDNT_CONNECT`
    from its perform function.
  prefs: []
  type: TYPE_NORMAL
- en: If you want to return a file descriptor that is *already connected* to a server,
    then you must also set the [sockopt callback](ch218.xhtml#transfers__callbacks__sockopt__md)
    and make sure that returns the correct return value.
  prefs: []
  type: TYPE_NORMAL
- en: 'The `curl_sockaddress` struct looks like this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE2]'
  prefs: []
  type: TYPE_PRE
- en: Socket close callback
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'The corresponding callback to the open socket is of course the close socket.
    Usually when you provide a custom way to provide a file descriptor you want to
    provide your own cleanup version as well:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE3]'
  prefs: []
  type: TYPE_PRE
- en: 'The `closesocket_callback` function must match this prototype:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE4]'
  prefs: []
  type: TYPE_PRE
