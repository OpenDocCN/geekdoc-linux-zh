- en: Scripting browser-like tasks
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 脚本化类似浏览器的任务
- en: curl can do almost every HTTP operation and transfer your favorite browser can.
    It can actually do a lot more than so as well, but in this chapter we focus on
    the fact that you can use curl to reproduce, or script, what you would otherwise
    have to do manually with a browser.
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: curl可以执行几乎所有的HTTP操作，并且可以像你最喜欢的浏览器一样传输。实际上，它还可以做更多的事情，但在这个章节中，我们关注的是你可以使用curl来重现或脚本化你否则必须手动使用浏览器执行的操作。
- en: Here are some tricks and advice on how to proceed when doing this.
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 这里有一些技巧和建议，关于在执行此操作时如何进行。
- en: Figure out what the browser does
  id: totrans-3
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 确定浏览器做了什么
- en: This is really a necessary first step. Second-guessing what it does risks having
    you chase down the wrong problem rat-hole. The scientific approach to this problem
    pretty much requires that you first understand what the browser does.
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
  zh: 这实际上是一个必要的第一步。猜测它做了什么可能会让你陷入错误的问题陷阱。对这个问题的科学方法几乎要求你首先了解浏览器做了什么。
- en: To learn what the browser does to perform a certain task, you can either read
    the HTML pages that you operate on and with a deep enough knowledge you can see
    what a browser would do to accomplish it and then start trying to do the same
    with curl.
  id: totrans-5
  prefs: []
  type: TYPE_NORMAL
  zh: 要了解浏览器如何执行特定任务，你可以阅读你操作的HTML页面，如果你有足够的知识，你可以看到浏览器为了完成它会如何操作，然后开始尝试用curl做同样的事情。
- en: The slightly more effective way, that also works even for the cases when the
    page is shock-full of obfuscated JavaScript, is to run the browser and monitor
    what HTTP operations it performs.
  id: totrans-6
  prefs: []
  type: TYPE_NORMAL
  zh: 一种稍微有效的方法，即使在页面充满了混淆的JavaScript的情况下也能工作，是运行浏览器并监控它执行的HTTP操作。
- en: The [Copy as curl](ch077.xhtml#cmdline__copyas__md) section describes how you
    can record a browser’s request and easily convert that to a curl command line.
  id: totrans-7
  prefs: []
  type: TYPE_NORMAL
  zh: '[复制为curl](ch077.xhtml#cmdline__copyas__md)部分描述了如何记录浏览器的请求并将其轻松转换为curl命令行。'
- en: Those copied curl command lines are often not good enough though since they
    tend to copy *exactly* that request, while you probably want to be a bad bit more
    dynamic so that you can reproduce the same operation and not just resend the verbatim
    request.
  id: totrans-8
  prefs: []
  type: TYPE_NORMAL
  zh: 虽然复制curl命令行通常还不够好，因为它们倾向于**精确地**复制那个请求，而你可能更希望它更加动态，以便你可以重现相同的操作，而不仅仅是重新发送原始请求。
- en: Cookies
  id: totrans-9
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: Cookies
- en: A lot of the web today works with a username and password login prompt somewhere.
    In many cases you even logged in a while ago with your browser but it has kept
    the state and keeps you logged in.
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: 当今许多网站都使用某个地方的用户名和密码登录提示。在许多情况下，你甚至很久以前就已经用浏览器登录过了，但它保持了状态，并保持你登录的状态。
- en: The logged-in state is almost always done by using [cookies](cookies/). A common
    operation would be to first login and save the returned cookies in a file, and
    then let the site update the cookies in the subsequent command lines when you
    traverse the site with curl.
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
  zh: 登录状态几乎总是通过使用[cookies](cookies/)来完成的。一个常见的操作是首先登录并将返回的cookies保存到文件中，然后当使用curl遍历网站时，让网站在后续的命令行中更新cookies。
- en: Web logins and sessions
  id: totrans-12
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 网络登录和会话
- en: The site at https://example.com/ features a login prompt. The login on the web
    site is an HTML form to which you send a [HTTP POST](post/) to. Save the response
    cookies and the response (HTML) output.
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: 网址为https://example.com/的网站有一个登录提示。该网站的登录是一个HTML表单，你向其发送一个[HTTP POST](post/)请求。保存响应cookies和响应（HTML）输出。
- en: Although the login page is visible (if you would use a browser) on https://example.com/,
    the HTML form tag on that page informs you about which exact URL to send the POST
    to, using the `action` parameter.
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: 尽管登录页面在https://example.com/上是可见的（如果你使用浏览器），但该页面的HTML表单标签会告诉你应该将POST发送到哪个确切的URL，使用`action`参数。
- en: 'In our imaginary case, the form tag looks like this:'
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: 在我们的假设案例中，表单标签看起来像这样：
- en: '[PRE0]'
  id: totrans-16
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: There are three fields of importance. **text**, **secret** and **id**. The last
    one, the id, is marked `hidden` which means that it does not show up in the browser
    and it is not a field that a user fills in. It is generated by the site itself,
    and for your curl login to succeed, you need extract that value and use that in
    your POST submission together with the rest of the data.
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
  zh: 有三个重要的字段。**text**、**secret**和**id**。最后一个，即id，被标记为`hidden`，这意味着它不会在浏览器中显示，并且它不是一个用户需要填写的字段。它由网站本身生成，为了你的curl登录成功，你需要提取该值，并在POST提交中使用该值以及其余数据。
- en: 'Send correct contents to the fields to the correct destination URL:'
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: 将正确的内容发送到正确的目标URL的字段：
- en: '[PRE1]'
  id: totrans-19
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: 'Many login pages even send you a session cookie already when presenting the
    login, and since you often need to extract the hidden fields from the `<form>`
    tag anyway, you could do something like this first:'
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
  zh: 许多登录页面甚至在你展示登录时就已经发送了会话cookie，而且由于你通常需要从`<form>`标签中提取隐藏字段，你可以先这样做：
- en: '[PRE2]'
  id: totrans-21
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: 'You would often need an HTML parser or some scripting language to extract the
    id field from there and then you can proceed and login as mentioned above, but
    with the added cookie loading (I am splitting the line into two lines to make
    it more readable):'
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: 你通常会需要一个HTML解析器或某种脚本语言来从那里提取id字段，然后你可以继续按照上述方法登录，但增加了cookie加载（我将这一行分成两行以提高可读性）：
- en: '[PRE3]'
  id: totrans-23
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: You can see that it uses both `-b` for reading cookies from the file and `-c`
    to store cookies again, for when the server sends back updated cookies.
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以看到它同时使用了`-b`来从文件中读取cookies，以及`-c`来存储cookies，以便在服务器发送回更新的cookies时使用。
- en: Always, *always*, add `-v` to the command lines when working out the details.
    See also the [verbose](../usingcurl/verbose/) section for more details on that.
  id: totrans-25
  prefs: []
  type: TYPE_NORMAL
  zh: 总是，*总是*，在处理细节时添加`-v`到命令行。有关更多详细信息，请参阅[详细输出](../usingcurl/verbose/)部分。
- en: Redirects
  id: totrans-26
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 重定向
- en: It is common for servers to use [redirects](ch167.xhtml#http__redirects__md)
    when responding to a login POST. It is so common I would probably say it is rare
    that it is not solved with a redirect.
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
  zh: 服务器在响应登录POST请求时使用[重定向](ch167.xhtml#http__redirects__md)是很常见的。如此常见，以至于我可能会说，如果不通过重定向解决，那是非常罕见的。
- en: 'You then just need to remember that curl does not follow redirects automatically.
    You need to instruct it to do this by adding the `-L` command line option. Adding
    that to the previous command line then makes the full one look like:'
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
  zh: 然后，你只需记住curl不会自动跟随重定向。你需要通过添加`-L`命令行选项来指示它这样做。将此添加到之前的命令行后，完整的命令行看起来像这样：
- en: '[PRE4]'
  id: totrans-29
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: Post-login
  id: totrans-30
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 登录后
- en: In the above example command lines, we save the login response output in a file
    named ‘out’ and in your script you should probably verify that it contains some
    text or something that confirms that the login is successful.
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: 在上述示例命令行中，我们将登录响应输出保存到名为‘out’的文件中，在你的脚本中，你可能需要验证它包含一些文本或确认登录成功的某些内容。
- en: Once successfully logged in, get the files or perform the HTTP operations you
    need and remember to keep using both `-b` and `-c` on the command lines to use
    and update the cookies.
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦成功登录，获取所需的文件或执行HTTP操作，并记得在命令行上继续使用`-b`和`-c`来使用和更新cookies。
- en: Referer
  id: totrans-33
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 引用者
- en: 'Some sites verify that the `Referer:` is actually identifying the legitimate
    parent URL when you request something or when you login or similar. You can then
    inform the server from which URL you arrived by using `-e https://example.com/`
    etc. Appending that to the previous login attempt then makes it:'
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: 一些网站在请求某些内容或登录或类似操作时，会验证`Referer:`是否确实标识了合法的父URL。然后，你可以通过使用`-e https://example.com/`等来通知服务器你从哪个URL到达的。将此添加到之前的登录尝试后，它看起来像这样：
- en: '[PRE5]'
  id: totrans-35
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: TLS fingerprinting
  id: totrans-36
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: TLS指纹识别
- en: Anti-bot detections nowadays use TLS fingerprinting to figure out whether a
    request is coming from a browser. Curl’s fingerprint can vary depending on your
    environment and most likely is different from those of browsers. Curl’s CLI does
    not have options to change all the various parts of the fingerprint, however an
    advanced user can customize the fingerprint through the use of libcurl and by
    compiling curl from source themselves.
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
  zh: 现今，反机器人检测通常使用TLS指纹识别来确定请求是否来自浏览器。Curl的指纹可能会根据你的环境而变化，并且很可能是与浏览器不同的。Curl的CLI没有选项来更改指纹的各个部分，但是高级用户可以通过使用libcurl并自行编译curl来自定义指纹。
