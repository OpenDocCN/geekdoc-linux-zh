# 理解基于目录的分片

> 原文：[`techbyexample.com/directory-based-sharding/`](https://techbyexample.com/directory-based-sharding/)

目录

+   概述

+   何时使用基于目录的分片

+   基于目录的分片的缺点

+   热分片问题

    +   解决方案 1

    +   解决方案 2

+   结论

# **概述**

在本教程中，我们将尝试理解基于目录的分片。除了基于目录的分片外，还有两种其他类型的分片

+   基于键的分片

+   基于范围的分片

基于目录的分片保持一个静态查找表，用来追踪哪些分片存储了哪些数据。让我们考虑一个例子。假设你需要跟踪美国不同地区的所有餐馆。每个餐馆将属于美国的某个特定位置。我们可以将美国划分为多个区域，每个区域将存储在一个独立的分片中。

**餐馆表**

| 餐馆名称 | 区域 |
| --- | --- |
| R1 | ZA |
| R2 | ZB |
| R3 | ZC |
| R4 | ZA |
| R5 | ZD |
| R6 | ZB |

现在我们将维护一个查找表，用于存储区域与分片的映射关系

**查找表**

| 区域 | 分片 |
| --- | --- |
| ZA | 1 |
| ZB | 2 |
| ZC | 3 |
| ZD | 4 |

很有可能两个区域会存储在同一个分片中，这是允许的。这个查找表通常保存在应用程序和数据库之外

# **何时使用基于目录的分片。**

+   当查找表基于的列的基数较低时。

例如，在上述情况中，我们将在美国范围内有固定数量的区域。即使存在一百万条餐馆记录，区域的数量也是固定的。因此，餐馆表中的区域列的基数较低。

作为反例，我们不能使用查找表中的**employee_id**，因为如果有比如说 2 万个员工，那么就会有 2 万个不同的**employee_id**，这会导致查找表的大小是无限的，因为这里**employee_id**列的基数较高

另一个重要因素是，除了列的基数较低外，列的值也不应该发生变化。例如，考虑一个**订单**表。一个订单会有不同的状态

+   初始化

+   成功

+   失败

+   已发货

在这里，状态列的基数较低，但订单可以从初始化状态变为**成功**或**失败**。从**成功**状态，它可以变为**已发货**。因此，状态列不是适合用作查找表的字段，否则，订单的状态变化时，订单会从一个分片转移到另一个分片。

# **基于目录的分片的缺点**

+   **查找表的开销**

每次我们想知道用户数据属于哪个分片时，都需要查询查找表。这种查找操作会在每次读写时发生。

+   **查找表作为单点故障**

查找表可以保存在一个单独的位置，可能是 Redis 或其他数据库。这个查找表可能成为单点故障。因此，我们必须维护多个查找表的副本。

# **热门分片问题**

像其他任何分片技术一样，这种分片方法也可能导致几个热门分片。所以通常在做基于目录的分片时，分片键的选择是让数据在各个分片之间均匀分布。在上述例子中，我们可以认为某些区域可能包含比其他区域更多的餐馆。在这种情况下，我们可以通过两种方式来解决这个问题。

## **解决方案 1**

+   将一些餐馆数量较少的区域映射到同一个分片。但将餐馆数量较多的区域映射到一个分片。例如，假设在上面的例子中，**ZA**和**ZB**有大量餐馆，而**ZC**和**ZD**的餐馆较少。那么查找表可能会是这样的。

**查找表**

| 区域 | 分片 |
| --- | --- |
| ZA | 1 |
| ZB | 2 |
| ZC | 3 |
| ZD | 3 |

## **解决方案 2**

使用混合方法。我们可以通过区域和子区域的组合来决定分片。例如，ZA 包含了很多餐馆，无法简单地放入一个分片中。此时，区域和子区域的组合将决定分片。

**餐馆表**

| 餐馆名称 | 区域 | 子区域 |
| --- | --- | --- |
| R1 | ZA | X |
| R2 | ZB | X |
| R3 | ZC | X |
| R4 | ZA | Y |
| R5 | ZD | X |
| R6 | ZB | Y |
| 区域 | 分片 |
| ZA_X | 1 |
| ZA_Y | 2 |
| ZB_X | 3 |
| ZB_Y | 4 |
| ZC_X | 5 |
| ZC_Y | 5 |
| ZD_X | 6 |
| ZD_Y | 6 |

区域**ZA**和**ZB**的子区域映射到不同的分片。而区域**ZC**和**ZD**的子区域映射到同一个分片。

# **结论**

这完全是基于目录的分片。希望你喜欢这篇文章。
