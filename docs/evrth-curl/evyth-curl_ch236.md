# 代理

在网络环境中，代理是一个中间人，位于您作为客户端和您想要与之通信的远程服务器之间的服务器。客户端联系中间人，然后中间人继续为您联系远程服务器。

这种代理使用方式有时被公司和组织使用，在这种情况下，您通常需要使用它们来访问目标服务器。

在与代理通信时，有几种不同的代理类型和不同的协议，libcurl 支持其中一些最常用的代理协议。重要的是要认识到，用于代理的协议不一定与用于远程服务器的协议相同。

当使用 libcurl 设置传输时，您需要指定代理服务器的名称和端口号。您可能会发现，您喜欢的浏览器在这一点上可能比 libcurl 更高级，我们将在后面的章节中详细介绍这些细节。

## 代理类型

libcurl 支持两种主要的代理类型：SOCKS 和 HTTP 代理。更具体地说，它支持带有或不带有远程名称查找的 SOCKS4 和 SOCKS5，以及到本地代理的 HTTP 和 HTTPS。

指定您正在与之通信的代理类型的简单方法是将代理主机名字符串的方案部分（`CURLOPT_PROXY`）设置为匹配它：

```sh
socks4://proxy.example.com:12345/
socks4a://proxy.example.com:12345/
socks5://proxy.example.com:12345/
socks5h://proxy.example.com:12345/
http://proxy.example.com:12345/
https://proxy.example.com:12345/
```

`socks4` - 表示带有本地名称解析的 SOCKS4

`socks4a` - 表示带有代理名称解析的 SOCKS4

`socks5` - 表示带有本地名称解析的 SOCKS5

`socks5h` - 表示带有代理名称解析的 SOCKS5

`http` - 表示 HTTP，这总是让代理解析名称

`https` - 表示代理的 HTTPS，这总是让代理解析名称。

如果您更喜欢只设置主机名，可以选择使用单独的选项设置代理类型，使用`CURLOPT_PROXYTYPE`。同样，您可以使用`CURLOPT_PROXYPORT`设置要使用的代理端口号。

## 本地或代理名称解析

在上面的某个部分中，您可以看到不同的代理设置允许不同的参与方在传输中执行名称解析。在几种情况下，您可以选择让客户端解析服务器主机名并将 IP 地址传递给代理以连接，当然这假设名称查找在客户端系统上工作准确无误 - 或者您可以将名称交给代理，让代理解析名称；将其转换为要连接的 IP 地址。

当您使用 HTTP 或 HTTPS 代理时，您始终需要将名称提供给代理以进行解析。

## 哪个代理？

如果您的网络连接需要使用代理来访问目标，您必须找出这一点，并告诉 libcurl 使用正确的代理。libcurl 没有自动确定或检测代理的支持。

当使用浏览器时，提供代理 PAC 脚本或其他方式是很常见的，但 libcurl 不识别这些方式。

### 代理环境变量

如果没有设置代理选项，libcurl 在执行传输之前会检查是否存在特别命名的环境变量，以查看是否请求使用代理。

你可以通过设置一个名为 `[scheme]_proxy` 的变量来指定代理主机名（与使用 `-x` 指定主机的方式相同）。如果你想告诉 curl 在访问 HTTP 服务器时使用代理，你设置 `http_proxy` 环境变量。如下所示：

```sh
http_proxy=http://proxy.example.com:80
```

上面的代理示例是针对 HTTP 的，但当然也可以为想要代理的特定协议设置 `ftp_proxy`、`https_proxy` 等等。除了 http_proxy 之外，所有这些代理环境变量名称也可以用大写指定，例如 `HTTPS_PROXY`。

要设置一个控制所有协议的单个变量，存在 `ALL_PROXY`。如果存在特定的协议变量，则该变量具有优先级。

当使用环境变量设置代理时，你可能会遇到一种情况，即一个或几个主机名应该被排除在代理之外。这可以通过 `NO_PROXY` 变量或相应的 `CURLOPT_NOPROXY` libcurl 选项来实现。将 `NO_PROXY` 设置为一个以逗号分隔的主机名列表，这些主机名在访问时不应使用代理。你可以将 NO_PROXY 设置为单个星号（‘*’）以匹配所有主机。

## HTTP 代理

HTTP 协议详细说明了如何使用 HTTP 代理。客户端（libcurl）不是将请求发送到实际远程服务器，而是请求代理提供特定资源。与 HTTP 代理的连接使用未加密的普通 HTTP。

如果请求 HTTPS 资源，libcurl 将会向代理发送一个 `CONNECT` 请求。这样的请求通过代理打开一个隧道，其中数据通过隧道传输而不被理解。这样，即使存在 HTTP 代理，libcurl 也能建立安全的端到端 TLS 连接。

你可以在 HTTP 代理上代理非 HTTP 协议，但这是通过 CONNECT 方法通过它进行隧道传输来完成的，因此需要代理配置为允许客户端连接到那些特定的远程端口号。许多 HTTP 代理被设置为禁止连接到 80 和 443 之外的端口号。

## HTTPS 代理

HTTPS 代理类似于 HTTP 代理，但允许客户端使用安全的 HTTPS 连接连接到它。由于在这种情况下代理连接与远程站点的连接是分开的，即使在这种情况下，HTTPS 到远程站点的连接也是通过代理的 HTTPS 连接进行隧道传输的，因此 libcurl 为代理连接提供了一整套与远程主机连接分开的 TLS 选项。

例如，`CURLOPT_PROXY_CAINFO` 对于 HTTPS 代理的功能与 `CURLOPT_CAINFO` 对于远程主机相同。`CURLOPT_PROXY_SSL_VERIFYPEER` 是 `CURLOPT_SSL_VERIFYPEER` 的代理版本，等等。

到今天为止，HTTPS 代理在组织和公司中仍然相当不常见。

## 代理认证

使用代理进行身份验证意味着您需要在与代理本身的握手协商中提供有效的凭据。然后，代理身份验证是在可能的远程主机身份验证或缺乏身份验证的基础上额外进行的。

libcurl 支持 HTTP、HTTPS 和 SOCKS5 代理的身份验证。关键选项是 `CURLOPT_PROXYUSERPWD`，它设置要使用的用户名和密码 - 除非您在 `CURLOPT_PROXY` 字符串中设置它。

## HTTP 代理头部

使用 HTTP 或 HTTP 代理时，libcurl 会向代理发送一个包含一组头部的请求。当然，应用程序可以修改这些头部，就像向服务器发送请求一样。

libcurl 提供了 `CURLOPT_PROXYHEADER` 以控制发送到代理的头部 **当向服务器发送单独的请求时**。这通常意味着发送到代理的初始 `CONNECT` 请求，用于通过代理设置隧道。
