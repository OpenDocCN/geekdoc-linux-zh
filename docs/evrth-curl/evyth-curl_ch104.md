# 名称解析技巧

curl 提供了许多方法来使其使用不同于它通常连接到的主机。

## 编辑 hosts 文件

也许你希望命令`curl http://example.com`连接到你的本地服务器而不是实际的服务器。

你通常可以很容易地通过编辑你的`hosts`文件（Linux 和 Unix-like 系统上的`/etc/hosts`）并添加例如`127.0.0.1 example.com`来重定向主机到你的本地主机。然而，这种编辑需要管理员权限，并且它的缺点是它同时影响了所有其他应用程序。

## 更改 Host:头

`Host:`头是 HTTP 客户端告诉 HTTP 服务器它正在与哪个服务器通信的正常方式，因为通常一个 HTTP 服务器使用相同的软件实例为许多不同的名称提供服务。

因此，通过传递一个自定义修改的`Host:`头，你可以在实际上没有连接到该主机名的情况下让服务器响应网站的内容。

例如，你在本地机器上运行你主站`www.example.com`的测试实例，并且希望 curl 请求 index html：

```sh
curl -H "Host: www.example.com" http://localhost/
```

当设置自定义`Host:`头并使用 cookie 时，curl 会提取自定义名称并将其用作匹配 cookie 发送时的主机。

当与 HTTPS 服务器通信时，`Host:`头是不够的。在 HTTPS 中，TLS 协议中有一个单独的扩展字段，称为 SNI（服务器名称指示），它允许客户端告诉服务器它想要与之通信的服务器名称。curl 只从给定的 URL 中提取 SNI 名称以发送。

## 为一个名称提供自定义 IP 地址

你是否比 curl 的名称解析器更清楚 curl 应该去哪里？那么你可以自己给 curl 提供一个 IP 地址。如果你想将`example.com`的 80 端口访问重定向到你的本地主机：

```sh
curl --resolve example.com:80:127.0.0.1 http://example.com/
```

你甚至可以指定多个`--resolve`开关来提供这种类型的多个重定向，这在处理的 URL 使用 HTTP 重定向或你只想让命令行与多个 URL 一起工作时非常有用。

`--resolve`将地址插入 curl 的 DNS 缓存中，因此它实际上让 curl 相信这是它在解析名称时得到的地址。

当谈论 HTTPS 时，这会发送 URL 中的名称的 SNI，curl 验证服务器的响应以确保它为 URL 中的名称提供服务。

你在选项中指定的模式需要是一个主机名及其对应的端口号，并且只有当 URL 中使用该精确对时，地址才会被替换。例如，如果你想替换 HTTPS URL 中默认端口号的主机名，你需要告诉 curl 它是 443 端口，如下所示：

```sh
curl --resolve example.com:443:192.168.0.1 https://example.com/
```

## 提供一个替换名称

作为`--resolve`选项的近亲，`--connect-to`选项提供了一个小的变化。它允许你指定 curl 在特定名称和端口号用于连接时在底层使用的替换名称和端口号。

例如，假设你有一个名为 `www.example.com` 的单一站点，该站点实际上由三个不同的 HTTP 服务器提供服务：load1、load2 和 load3，用于负载均衡。在典型正常流程中，curl 解析主站点并与负载均衡服务器之一（因为它返回一个列表并从中选择一个）进行通信，一切正常。如果你想向负载均衡集中的一个特定服务器发送测试请求（例如 `load1.example.com`），你可以指示 curl 执行该操作。

如果你知道 load1 的特定 IP 地址，你仍然可以使用 `--resolve` 来完成这个任务。但无需首先单独解析和修复 IP 地址，你可以告诉 curl：

```sh
curl --connect-to www.example.com:80:load1.example.com:80 \
  http://www.example.com
```

它将源名称加源端口重定向到目标名称加目标端口。curl 然后解析 `load1.example.com` 名称并连接，但在所有其他方面仍然假设它正在与 `www.example.com` 进行通信。

## 使用 c-ares 的名称解析技巧

正如本书其他地方应详细说明的那样，curl 可以使用几个不同的名称解析后端进行构建。其中之一是由 c-ares 库提供的后端，当 curl 构建为使用 c-ares 时，它获得了一些额外的超级能力，而构建为使用其他名称解析后端的 curl 则没有这些能力。具体来说，它获得了更具体地指示使用哪些 DNS 服务器以及 DNS 流量如何使用网络的能力。

使用 `--dns-servers`，你可以指定 curl 应该使用哪个 DNS 服务器而不是默认的 DNS 服务器。这让你可以运行自己的实验性服务器，该服务器会以不同的方式回答，或者如果常规服务器不可靠或已死亡，可以使用备份服务器。

使用 `--dns-ipv4-addr` 和 `--dns-ipv6-addr`，你要求 curl 将 DNS 通信的本地端“绑定”到特定的 IP 地址，而使用 `--dns-interface`，你可以指示 curl 使用特定的网络接口来发送 DNS 请求。

这些 `--dns-*` 选项是高级的，并且仅适用于了解自己在做什么且理解这些选项作用的人。但它们提供了可定制的 DNS 域名解析操作。
