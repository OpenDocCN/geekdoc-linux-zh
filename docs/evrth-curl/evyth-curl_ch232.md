# libcurl 的连接方式

当 libcurl 即将进行互联网传输时，它首先*解析*主机名以获取主机的 IP 地址数量。主机名至少需要有一个地址，libcurl 才能连接到它。

一个主机名可以同时具有 IPv4 地址和 IPv6 地址，并且它们可以有一组。

如果主机只返回了单个 IP 族的地址，libcurl 会遍历每个地址并尝试连接。如果某个 IP 的连接尝试失败，libcurl 将继续尝试下一个条目，直到列表中的所有条目都尝试完毕。

应用程序可以通过设置`CURLOPT_IPRESOLVE`来限制 libcurl 使用的 IP 版本。

## Happy Eyeballs

当它已经收到了主机的 IPv4 和 IPv6 地址，libcurl 首先尝试连接到 IPv6 地址，然后经过短暂的延迟，它尝试连接到第一个 IPv4 地址——同时并行进行。一旦其中一个尝试成功，其他尝试将被丢弃。这种同时使用两个家族尝试连接的方法被称为**Happy Eyeballs**，并且是互联网客户端广泛接受的最佳实践。

应用程序可以通过使用`CURLOPT_HAPPY_EYEBALLS_TIMEOUT_MS`来设置 Happy Eyeballs 过程中第二个家族连接尝试的延迟。

## 超时和减半

连接阶段有一个最大允许时间（通过`CURLOPT_CONNECTTIMEOUT_MS`设置），默认为 300 秒。如果在那个时间内没有成功连接，整个连接过程被认为是失败的。

当 libcurl 还有多个地址需要尝试连接，并且剩余时间超过 600 毫秒时，它最多允许这次尝试使用剩余时间的一半。这是为了避免单个陷阱地址让 libcurl 在错误条目上消耗其整个超时时间。

例如：如果剩余超时时间为 1000 毫秒，并且还有两个 IP 地址需要尝试连接，那么 libcurl 在下一个尝试中只允许 500 毫秒。

如果只剩下 600 毫秒的超时时间，并且还有两个 IP 地址需要尝试连接，libcurl 允许在下一个尝试中使用整个剩余的超时时间，以避免超时时间太短而无法成功。只有在剩余时间超过 600 毫秒的情况下，才会执行超时减半的方法。

## HTTP/3

对于要求 libcurl 使用 HTTP/3 的应用程序，它会在 Happy Eyeballs 的基础上增加另一层。HTTP/3 在 QUIC 上工作，而 QUIC 是一种与 TCP 不同的传输协议，有时可能会被阻止或不如 TCP 工作得那么好。为了平滑这种问题带来的影响，libcurl 除了上述不同 IP 版本连接外，还会并行执行 QUIC 连接和常规 TCP 连接。

当 libcurl 获取到主机的 IPv4 和 IPv6 地址，并且它想要与该主机进行 HTTP/3 通信时，它将按以下方式进行：

1.  开始一个 IPv6 QUIC 连接尝试，遍历 IPv6 地址

1.  短暂延迟后，开始一个 IPv4 QUIC 连接尝试，遍历 IPv4 地址

1.  短暂延迟后，开始一个 IPv6 TCP 连接尝试，遍历 IPv6 地址

1.  短暂延迟后，开始一个 IPv4 TCP 连接尝试，遍历 IPv4 地址

一旦连接尝试成功，其他所有尝试将立即被丢弃。

当 libcurl 被要求使用 `CURL_HTTP_VERSION_3` 而不是设置为 `CURL_HTTP_VERSION_3ONLY` 时，才会进行 HTTP/3 happy eyeballing。
