# 两个连接

FTP 使用两个 TCP 连接。第一个连接是由客户端在连接到 FTP 服务器时设置的，被称为*控制连接*。作为初始连接，它负责处理认证以及更改远程服务器上的正确目录等。当客户端准备好传输文件时，会建立第二个 TCP 连接，数据通过该连接传输。

建立第二个连接的原因有几个，这会导致麻烦和头痛。

## 主动连接

客户端可以选择要求服务器连接到客户端以进行设置，这被称为*主动*连接。这是通过 PORT 或 EPRT 命令完成的。允许远程主机连接回客户端打开的端口需要中间没有防火墙或其他网络设备拒绝该连接，但这并不总是情况。您可以使用`curl -P [arg]`（也称为`--ftp-port`的长格式）请求一个主动传输，虽然该选项允许您指定确切要使用的地址，但将地址设置为与您连接的地址几乎总是正确的选择，您可以通过`-P -`这样做，如下请求文件的方式：

```sh
curl -P - ftp://example.com/foobar.txt
```

您还可以显式要求 curl 不使用 EPRT（这是一个比 PORT 稍微新一点的命令）通过`--no-eprt`命令行选项。

## 被动连接

Curl 默认请求一个*被动*连接，这意味着它会向服务器发送 PASV 或 EPSV 命令，然后服务器打开一个新的端口用于第二个连接，curl 随后连接到该端口。对于终端用户和客户端来说，向新端口发出的连接通常更容易且限制较少，但需要服务器端的网络允许这样做。

默认情况下，被动连接已被启用，但如果您之前已经开启了主动连接，您可以使用`--ftp-pasv`将其切换回被动连接。

您还可以显式要求 curl 不使用 EPSV（这是一个比 PASV 稍微新一点的命令）通过`--no-epsv`命令行选项。

有时服务器运行的是一个古怪的配置，当 curl 发出 PASV 命令且服务器响应一个 curl 需要连接的 IP 地址时，该地址是错误的，然后 curl 无法设置数据连接。对于这种（罕见）情况，您可以要求 curl 忽略 PASV 响应中提到的 IP 地址（`--ftp-skip-pasv-ip`），而使用与控制连接相同的 IP 地址，即使是第二个连接也是如此。

## 防火墙问题

使用主动或被动传输时，网络路径中现有的防火墙基本上必须对 FTP 流量进行状态检查，以确定要打开的新端口并接受第二个连接。
