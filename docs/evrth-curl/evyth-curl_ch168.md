# 重定向

“重定向”是 HTTP 协议的基本部分。这个概念在 1996 年发布的第一个规范（RFC 1945）中就已经存在，并且有记录，自那时起一直被广泛使用。

重定向就是其字面意思。服务器向客户端发送指令，而不是返回客户端请求的内容。服务器会说“去找这里看看你请求的那个东西”。

重定向并不完全相同。重定向是永久的吗？客户端在下一个请求中应该使用什么请求方法？

所有重定向都需要发送回一个`Location:`头，包含请求的新 URI，可以是绝对路径或相对路径。

## 永久和临时

重定向是打算持续存在还是只是暂时有效？如果你想通过另一个 GET 永久性地将用户重定向到资源 B，请发送回 301。这也意味着用户代理（浏览器）打算缓存此操作，并从现在开始，当请求原始 URI 时，继续访问新的 URI。

临时替代方案是 302。目前服务器希望客户端向 B 发送 GET 请求，但它不应该缓存这个请求，而应该在下次被指引到原始 URI 时继续尝试。

注意，301 和 302 都会让浏览器在下一个请求中执行 GET 操作，这可能意味着如果它以 POST 开始（并且仅限于 POST），则需要更改方法。将 HTTP 方法从 GET 更改为 301 和 302 响应的说法是“出于历史原因”，但浏览器仍然这样做，因此大多数公共网络都表现出这种行为。

实际上，303 代码与 302 类似。它不会被缓存，并且它让客户端在下一个请求中发出 GET 请求。302 和 303 之间的区别很微妙，但 303 似乎是为对原始请求的“间接响应”而设计的，而不仅仅是重定向。

这三个代码是 HTTP/1.0 规范中唯一的重定向代码。

然而，curl 根本不记住或缓存任何重定向，因此对于它来说，永久重定向和临时重定向之间实际上没有区别。

## 告诉 curl 跟随重定向

在 curl 的传统中，除非你告诉它不同，否则它默认不跟随 HTTP 重定向。使用`-L, --location`选项来告诉它这样做。

当启用跟随重定向时，curl 默认跟随最多 30 个重定向。这个最大限制主要是为了避免陷入无限循环的风险。如果你觉得 30 不够用，你可以通过`--max-redirs`选项更改要跟随的最大重定向数。

## GET 或 POST？

这三个响应代码，301 和 302/303，都假设客户端发送 GET 来获取新的 URI，即使客户端可能在第一个请求中发送了 POST。这很重要，至少如果你做的是不使用 GET 的事情。

如果服务器希望将客户端重定向到新的 URI，并希望它在第二次请求中发送与第一次相同的方法，比如如果它首先发送了 POST，它希望它在下一个请求中再次发送 POST，服务器将使用不同的响应代码。

要告诉客户“你发送 POST 请求的 URI 已永久重定向到 B，你应该现在以及未来发送 POST 请求”，服务器会响应 308 状态码。更复杂的是，308 状态码是最近才定义的（[规范](https://tools.ietf.org/html/rfc7238#section-3)于 2014 年 6 月发布），因此较旧的客户端可能无法正确处理它。如果是这样，那么你剩下的唯一响应代码就是……

告诉客户端在下一个请求中也发送 POST 的（较旧的）响应代码是 307。尽管如此，客户端不会缓存此重定向，因此如果再次请求，它将再次向 A 发送 POST。307 代码是在 HTTP/1.1 中引入的。

哦，并且重定向在 HTTP/2 中与 HTTP/1.1 中的工作方式相同。

|  | 永久 | 临时 |
| --- | --- | --- |
| 切换到 GET | 301 | 302 和 303 |
| 保持原始方法 | 308 | 307 |

### 决定在重定向中使用的请求方法

结果表明，世界上确实存在一些希望将 POST 请求发送到原始 URL 的 Web 服务，但它们会以 HTTP 重定向的形式响应，使用 301、302 或 303 响应代码，并且仍然希望 HTTP 客户端将下一个请求作为 POST 发送。如上所述，浏览器不会这样做，curl 默认也不会这样做。

由于这些设置存在，而且实际上并不罕见，curl 提供了选项来改变其行为。

你可以通过使用专门为此目的提供的选项来告诉 curl 在 30x 响应后不要将非 GET 请求方法更改为 GET：`--post301`、`--post302`和`--post303`。如果你正在编写基于 libcurl 的应用程序，你可以通过`CURLOPT_POSTREDIR`选项来控制该行为。

## 重定向到其他主机名

当你使用 curl 时，你可以为特定站点提供用户名和密码等凭证，但由于 HTTP 重定向可能会移动到不同的主机，curl 限制了它发送到原始传输中其他主机的数据。

所以，如果你想将凭证也发送到后续的主机名，即使它们与原始主机名不同——可能是因为你信任它们，并且知道这样做没有害处——你可以通过使用`--location-trusted`选项告诉 curl 这样做是可以的。
