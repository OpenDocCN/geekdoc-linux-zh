# 连接重用

libcurl 保持着一组旧连接的活跃状态。当一个传输完成时，它会在连接池中保持 N 个连接的活跃状态（有时也称为连接缓存），以便后续的传输如果能够重用现有连接之一，就可以使用它而不是创建一个新的连接。重用连接而不是创建新连接在速度和所需资源方面提供了显著的好处。

当 libcurl 即将为传输目的创建新的连接时，它会首先检查连接池中是否存在可以重用的现有连接。连接重用检查在使用任何 DNS 或其他名称解析机制之前进行，因此它是基于主机名的。如果存在到正确主机名的现有活动连接，还会检查许多其他属性（端口号、协议等），以确保它可以被使用。

## Easy API 连接池

当您使用 easy API，或者更具体地说，`curl_easy_perform()`时，libcurl 将连接池与特定的 easy 句柄相关联。然后重用相同的 easy 句柄确保 libcurl 可以重用其连接。

## 多线程 API 连接池

当您使用多线程 API 时，连接池将与多线程句柄相关联。这允许您自由地清理和重新创建 easy 句柄，而不会丢失连接池，并允许一个 easy 句柄使用的连接在后续传输中被另一个单独的句柄重用。只需重用多线程句柄即可。

## 共享连接缓存

自从 libcurl 7.57.0 版本起，应用程序可以使用共享接口让原本独立的传输共享相同的连接池。

## 当连接没有按预期重用时

libcurl 会自动且始终尝试重用连接，除非明确告知不要这样做。然而，有几种原因会导致连接**不**用于后续传输。

+   服务器表示此传输后连接将关闭。例如，通过使用`Connection: close` HTTP 响应头或 HTTP/2 或 HTTP/3 的“离开”帧。

+   传输的 HTTP/1 响应是以这种方式发送的，即连接关闭是检测身体结束的唯一方式。或者只是一个使 curl 认为它不能再安全地重用连接的 HTTP/1 接收错误。

+   当 libcurl 尝试重用连接时，该连接被视为“死亡”。这可能发生在服务器端在先前的传输完成后关闭了连接。也可能发生在有状态防火墙/NAT 或网络路径中的其他部分断开了连接，或者在无人看管的情况下，连接上存在 HTTP/2 或 HTTP/3 流量（如 PING 帧）。

+   前一个传输被认为太旧，无法重用。如果设置了`CURLOPT_MAXLIFETIME_CONN`，libcurl 将不会重用超过设定秒数的旧连接。

+   之前的传输被认为空闲时间过长。默认情况下，libcurl 从不尝试重用空闲时间超过 118 秒的连接。这个时间可以通过 `CURLOPT_MAXAGE_CONN` 来更改。

+   如果在传输结束时连接池已满，并且即将有一个新连接存储在那里，则池中最旧的空闲连接将被关闭并丢弃，因此不能再重用。根据您使用的 API，可以通过 `CURLMOPT_MAXCONNECTS` 或 `CURLOPT_MAXCONNECTS` 来增加连接池的大小。

+   当使用多接口时，如果下一个传输开始时之前的传输尚未结束，并且之前的连接不能用于多路复用。

等等。通常，您可以通过启用 `CURLOPT_VERBOSE` 并检查 libcurl 向应用程序通知的内容来了解原因。
