- en: How libcurl connects
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: libcurl的连接方式
- en: When libcurl is about to do an Internet transfer, it first *resolves* the host
    name to get a number of IP addresses for the host. A hostname needs to have at
    least one address for libcurl to be able to connect to it.
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: 当libcurl即将进行互联网传输时，它首先*解析*主机名以获取主机的IP地址数量。主机名至少需要有一个地址，libcurl才能连接到它。
- en: A hostname can have both IPv4 addresses and IPv6 addresses and they can have
    a set of both.
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 一个主机名可以同时具有IPv4地址和IPv6地址，并且它们可以有一组。
- en: If the host only returned addresses of a single IP family, libcurl iterates
    over each address and tries to connect. If the connect attempt fails for an IP,
    libcurl continues to try the next entry until the entire list is exhausted.
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: 如果主机只返回了单个IP族的地址，libcurl会遍历每个地址并尝试连接。如果某个IP的连接尝试失败，libcurl将继续尝试下一个条目，直到列表中的所有条目都尝试完毕。
- en: An application can limit which IP versions libcurl uses by setting `CURLOPT_IPRESOLVE`.
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
  zh: 应用程序可以通过设置`CURLOPT_IPRESOLVE`来限制libcurl使用的IP版本。
- en: Happy Eyeballs
  id: totrans-5
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: Happy Eyeballs
- en: When it has received both IPv4 and IPv6 addresses for a host, libcurl first
    tries to connect to an IPv6 address and after a short delay it tries connecting
    to the first IPv4 address - at the same time and in parallel. Once one of the
    attempts succeeds, the others are discarded. This method of attempting to connect
    using both families at the same time is called **Happy Eyeballs** and is the widely
    accepted best practice for Internet clients.
  id: totrans-6
  prefs: []
  type: TYPE_NORMAL
  zh: 当它已经收到了主机的IPv4和IPv6地址，libcurl首先尝试连接到IPv6地址，然后经过短暂的延迟，它尝试连接到第一个IPv4地址——同时并行进行。一旦其中一个尝试成功，其他尝试将被丢弃。这种同时使用两个家族尝试连接的方法被称为**Happy
    Eyeballs**，并且是互联网客户端广泛接受的最佳实践。
- en: An application can set the delay with which the second family connect attempt
    starts in the Happy Eyeball procedure by using `CURLOPT_HAPPY_EYEBALLS_TIMEOUT_MS`.
  id: totrans-7
  prefs: []
  type: TYPE_NORMAL
  zh: 应用程序可以通过使用`CURLOPT_HAPPY_EYEBALLS_TIMEOUT_MS`来设置Happy Eyeballs过程中第二个家族连接尝试的延迟。
- en: Timeout and halving
  id: totrans-8
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 超时和减半
- en: The connection phase has a maximum allowed time (set with `CURLOPT_CONNECTTIMEOUT_MS`),
    which defaults to 300 seconds. The entire connect procedure is deemed failed if
    no connect has succeeded within that time.
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: 连接阶段有一个最大允许时间（通过`CURLOPT_CONNECTTIMEOUT_MS`设置），默认为300秒。如果在那个时间内没有成功连接，整个连接过程被认为是失败的。
- en: When libcurl has multiple addresses left to try to connect to, and there is
    more than 600 millisecond left, it will at most allow half the remaining time
    for this attempt. This is to avoid a single sink-hole address make libcurl spend
    its entire timeout on that bad entry.
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: 当libcurl还有多个地址需要尝试连接，并且剩余时间超过600毫秒时，它最多允许这次尝试使用剩余时间的一半。这是为了避免单个陷阱地址让libcurl在错误条目上消耗其整个超时时间。
- en: 'For example: if there are 1000 milliseconds left of the timeout and there are
    two IP addresses left to try to connect to, libcurl then only allows 500 milliseconds
    on the next attempt.'
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
  zh: 例如：如果剩余超时时间为1000毫秒，并且还有两个IP地址需要尝试连接，那么libcurl在下一个尝试中只允许500毫秒。
- en: If there instead only are 600 milliseconds left of the timeout and there are
    two IP addresses left to try to connect to, libcurl allows the entire remaining
    timeout period on the next attempt, in order to not make it too short to succeed.
    The timeout halving approach is only done as long as there is more than 600 milliseconds
    remaining.
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: 如果只剩下600毫秒的超时时间，并且还有两个IP地址需要尝试连接，libcurl允许在下一个尝试中使用整个剩余的超时时间，以避免超时时间太短而无法成功。只有在剩余时间超过600毫秒的情况下，才会执行超时减半的方法。
- en: HTTP/3
  id: totrans-13
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: HTTP/3
- en: For applications that ask libcurl to use HTTP/3, it adds another layer of Happy
    Eyeballs. HTTP/3 works over QUIC and QUIC is a different transport protocol than
    TCP and a mechanism that sometimes is blocked or otherwise does not work as well
    as TCP. In an effort to smooth out the problems this brings, libcurl performs
    QUIC connects *in parallel* with regular TCP connects in addition to the different
    IP version connects described above.
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: 对于要求libcurl使用HTTP/3的应用程序，它会在Happy Eyeballs的基础上增加另一层。HTTP/3在QUIC上工作，而QUIC是一种与TCP不同的传输协议，有时可能会被阻止或不如TCP工作得那么好。为了平滑这种问题带来的影响，libcurl除了上述不同IP版本连接外，还会并行执行QUIC连接和常规TCP连接。
- en: 'When libcurl get both IPv4 and IPv6 addresses for a host, and it wants to do
    HTTP/3 with the host, it proceeds like this:'
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: 当libcurl获取到主机的IPv4和IPv6地址，并且它想要与该主机进行HTTP/3通信时，它将按以下方式进行：
- en: Start an IPv6 QUIC connect attempt, iterate over the IPv6 addresses
  id: totrans-16
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 开始一个IPv6 QUIC连接尝试，遍历IPv6地址
- en: After a short delay, start an IPv4 QUIC connect attempt, iterate over the IPv4
    addresses
  id: totrans-17
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 短暂延迟后，开始一个 IPv4 QUIC 连接尝试，遍历 IPv4 地址
- en: After a short delay, start an IPv6 TCP connect attempt, iterate over the IPv6
    addresses
  id: totrans-18
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 短暂延迟后，开始一个 IPv6 TCP 连接尝试，遍历 IPv6 地址
- en: After a short delay, start an IPv4 TCP connect attempt, iterate over the IPv4
    addresses
  id: totrans-19
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 短暂延迟后，开始一个 IPv4 TCP 连接尝试，遍历 IPv4 地址
- en: Once a connect attempt is successful, all the other ones are immediately discarded.
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦连接尝试成功，其他所有尝试将立即被丢弃。
- en: The HTTP/3 happy eyeballing is done when libcurl is asked to use `CURL_HTTP_VERSION_3`
    but not if set to `CURL_HTTP_VERSION_3ONLY`.
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
  zh: 当 libcurl 被要求使用 `CURL_HTTP_VERSION_3` 而不是设置为 `CURL_HTTP_VERSION_3ONLY` 时，才会进行
    HTTP/3 happy eyeballing。
