- en: Protocol handler
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 协议处理程序
- en: libcurl is a multi-protocol transfer library. The core of the code is a set
    of generic functions that are used for transfers in general and mostly works the
    same for all protocols. The main state machine described above for example is
    there and works for all protocols - even though some protocols may not make use
    of all states for all transfers.
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: libcurl是一个多协议传输库。代码的核心是一组通用的函数，用于一般的传输，并且对于所有协议来说大多数情况下工作方式相同。上面描述的主要状态机就在那里，并且适用于所有协议——即使某些协议可能不会在所有传输中使用所有状态。
- en: However, each different protocol libcurl speaks also has its unique particularities
    and specialties. In order to not have the code littered with conditions in the
    style if the protocol is XYZ, then do…, we instead have the concept of `Curl_handler`.
    Each supported protocol defines one of those in `lib/url.c` there is an array
    of pointers to such handlers called `protocols[]`.
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 然而，curl支持的每种不同协议都有其独特的特性和专长。为了避免代码中充斥着“如果协议是XYZ，那么做……”这样的条件语句，我们引入了`Curl_handler`的概念。每个支持的协议在`lib/url.c`中定义了一个这样的处理程序，那里有一个指向这些处理程序的指针数组`protocols[]`。
- en: When a transfer is about to be done, libcurl parses the URL it is about to operate
    on and among other things it figures out what protocol to use. Normally this can
    be done by looking at the scheme part of the URL. For `https://example.com` that
    is `https` and for `imaps://example.com` it is `imaps`. Using the provided scheme,
    libcurl sets the `conn->handler` pointer to the handler struct for the protocol
    that handles this URL.
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: 当一个传输即将进行时，libcurl会解析它即将操作的URL，并确定要使用哪种协议。通常，这可以通过查看URL的方案部分来完成。对于`https://example.com`，这是`https`，对于`imaps://example.com`，它是`imaps`。使用提供的方案，libcurl将`conn->handler`指针设置为处理该URL的协议的处理程序结构体。
- en: '![](../media/file14.jpg)'
  id: totrans-4
  prefs: []
  type: TYPE_IMG
  zh: '![示例图片](../media/file14.jpg)'
- en: libcurl protocol handlers
  id: totrans-5
  prefs: []
  type: TYPE_NORMAL
  zh: libcurl协议处理程序
- en: The handler struct contains a set of function pointers that can be NULL or set
    to point to a protocol specific function to do things necessary for that protocol
    to work for a transfer. Things that not all other protocols need. The handler
    struct also sets up the name of the protocol and describes its feature set with
    a bitmask.
  id: totrans-6
  prefs: []
  type: TYPE_NORMAL
  zh: 处理程序结构体包含一组函数指针，可以是NULL或设置为指向特定于协议的函数，以执行该协议在传输中工作所需的事情。不是所有其他协议都需要的事情。处理程序结构体还设置了协议的名称，并使用位掩码描述其功能集。
- en: 'A libcurl transfer is built around a set of different actions and the handler
    can extend each of them. Here are some example function pointers in this struct
    and how they are used:'
  id: totrans-7
  prefs: []
  type: TYPE_NORMAL
  zh: libcurl的传输是围绕一组不同的动作构建的，处理程序可以扩展每一个动作。以下是一些该结构体中的示例函数指针及其使用方式：
- en: Setup connection
  id: totrans-8
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 设置连接
- en: 'If a connection cannot be reused for a transfer, it needs to setup a connection
    to the host given in the URL and when it does, it can also call the protocol handler’s
    function for it. Like this:'
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: 如果一个连接不能用于传输，它需要设置一个连接到URL中给出的主机，并且当它这样做时，它也可以调用该协议处理程序的功能。如下所示：
- en: '[PRE0]'
  id: totrans-10
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: Connect
  id: totrans-11
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 连接
- en: After a connection has been established, this function gets called
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: 在连接建立之后，这个函数会被调用
- en: '[PRE1]'
  id: totrans-13
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: Do
  id: totrans-14
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: Do
- en: '*Do* is simply the action that issues a request for the particular resource
    the URL identifies. All protocol has a do action so this function must be provided:'
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: '*Do* 简单地是发出对URL标识的特定资源的请求的动作。所有协议都有一个do动作，因此必须提供这个函数：'
- en: '[PRE2]'
  id: totrans-16
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: Done
  id: totrans-17
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: Done
- en: 'When a transfer is completed, the *done* action is taken:'
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: 当传输完成时，执行 *done* 动作：
- en: '[PRE3]'
  id: totrans-19
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: Disconnect
  id: totrans-20
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 断开连接
- en: The connection is about to be taken down.
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
  zh: 连接即将断开。
- en: '[PRE4]'
  id: totrans-22
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
